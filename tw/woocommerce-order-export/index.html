<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/tw/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/tw/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/tw/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/tw/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/tw/css/main.css">


<link rel="stylesheet" href="/tw/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"oberonlai.blog","root":"/tw/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideDownIn","sidebar":"slideDownIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="WooCoomerce 有許多方便又實用的外掛，可以解決企業在經營電子商務時所遇到的各種問題，但如果要與企業內部現有的系統進行整合，就勢必要針對既有系統的規格來進行 WooCommerce 的客製化開發。 需求分析客戶希望把 WooCommerce 訂單能於每日特定的時段自動匯出後整合至內部的管理系統，並當發生訂單取消或退貨時，也能把該筆訂單的資料傳送至該系統中。 既有的操作流程為人工使用外掛匯出">
<meta property="og:type" content="article">
<meta property="og:title" content="【 筆記 】WooCommerce 客製化報表自動匯出&amp;上傳功能開發">
<meta property="og:url" content="https://oberonlai.blog/tw/woocommerce-order-export/">
<meta property="og:site_name" content="WordPress 開發日常">
<meta property="og:description" content="WooCoomerce 有許多方便又實用的外掛，可以解決企業在經營電子商務時所遇到的各種問題，但如果要與企業內部現有的系統進行整合，就勢必要針對既有系統的規格來進行 WooCommerce 的客製化開發。 需求分析客戶希望把 WooCommerce 訂單能於每日特定的時段自動匯出後整合至內部的管理系統，並當發生訂單取消或退貨時，也能把該筆訂單的資料傳送至該系統中。 既有的操作流程為人工使用外掛匯出">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.14.48.jpg">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.27.22.jpg">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.40.58.jpg">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.41.16.jpg">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-12.36.54.jpg">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-09-at-11.03.29-1024x319.jpg">
<meta property="article:published_time" content="2020-07-09T13:44:50.000Z">
<meta property="article:modified_time" content="2021-05-01T10:35:49.241Z">
<meta property="article:author" content="賴俊吾 &#x2F; Oberon Lai">
<meta property="article:tag" content="wp-cron">
<meta property="article:tag" content="csv">
<meta property="article:tag" content="ftp">
<meta property="article:tag" content="WooCoomerce訂單">
<meta property="article:tag" content="報表匯出">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.14.48.jpg">

<link rel="canonical" href="https://oberonlai.blog/tw/woocommerce-order-export/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>【 筆記 】WooCommerce 客製化報表自動匯出&上傳功能開發 | WordPress 開發日常</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163107142-1"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-163107142-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta custom-logo">

    <a href="/tw/" class="brand" rel="start" style="display: block">
        <img class="logo-img" src="/tw/images/logo-w.svg" alt="WordPress 開發日常">
    </a>
      <p class="site-subtitle" itemprop="description">有任何 WordPress 客製需求歡迎與我聯絡！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-關於我">

    <a href="/tw/about/" rel="section">關於我</a>

  </li>
        <li class="menu-item menu-item-合作方式">

    <a href="/tw/how-can-oberon-help-you/" rel="section">合作方式</a>

  </li>
        <li class="menu-item menu-item-計價方式">

    <a href="/tw/how-do-i-make-a-quotation/" rel="section">計價方式</a>

  </li>
        <li class="menu-item menu-item-學習-wordpress">

    <a href="/tw/wordpress-full-stack/" rel="section">學習 WordPress</a>

  </li>
        <li class="menu-item menu-item-與我聯繫">

    <a href="mailto:m615926@gmail.com" rel="noopener" target="_blank">與我聯繫</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger">搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/oberonlai" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://oberonlai.blog/tw/woocommerce-order-export/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/tw/images/avatar.jpg">
      <meta itemprop="name" content="賴俊吾 / Oberon Lai">
      <meta itemprop="description" content="現為全職 WordPress 工程師，網站開發經歷 11 年，專攻前端工程與 WordPress 佈景主題、外掛客製化開發">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WordPress 開發日常">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【 筆記 】WooCommerce 客製化報表自動匯出&上傳功能開發
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-07-09 21:44:50" itemprop="dateCreated datePublished" datetime="2020-07-09T21:44:50+08:00">2020-07-09</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-05-01 18:35:49" itemprop="dateModified" datetime="2021-05-01T18:35:49+08:00">2021-05-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/tw/categories/WooCommerce/" itemprop="url" rel="index"><span itemprop="name">WooCommerce</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/tw/woocommerce-order-export/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="woocommerce-order-export/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>26 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>WooCoomerce 有許多方便又實用的外掛，可以解決企業在經營電子商務時所遇到的各種問題，但如果要與企業內部現有的系統進行整合，就勢必要針對既有系統的規格來進行 WooCommerce 的客製化開發。</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><p>客戶希望把 WooCommerce 訂單能於每日特定的時段自動匯出後整合至內部的管理系統，並當發生訂單取消或退貨時，也能把該筆訂單的資料傳送至該系統中。</p>
<p>既有的操作流程為人工使用外掛匯出 csv 後，手動調整其報表內容傳送至內部系統，問題點在於無法自動化與取得某些類型商品的價格，以及折扣金額的計算皆需要人為介入處理，因此需要設計一套自動化流程來解決這些繁瑣的任務，並減少人工整理報表時可能產生的問題。</p>
<p>完整流程如下：</p>
<span id="more"></span>

<p>一、訂單新增系統傳送狀態欄位，用來紀錄該訂單是否已被傳送至企業內部系統</p>
<p>二、後台可以篩選尚未傳送的訂單，勾選後使用批次動作來進行報表的匯出</p>
<p>三、訂單狀態變更為退費時自動匯出報表</p>
<p>四、用任何方式匯出的報表皆透過 FTP 傳到客戶的伺服器中</p>
<p>五、每天於特定時段把尚未傳送的訂單自動進行傳送</p>
<h2 id="任務拆解"><a href="#任務拆解" class="headerlink" title="任務拆解"></a>任務拆解</h2><p>理解了業務邏輯之後，接下來就是把每個流程轉變為具體的開發步驟：</p>
<p>ㄧ、WooCommerce 後台訂單介面新增欄位、欄位篩選下拉選單、批次編輯選項</p>
<p>二、WooCommerce 訂單資料取得</p>
<p>三、將取得的 WooCommerce 訂單資料組成 csv 檔，並寫入到 wp-content/uploads 資料夾</p>
<p>四、FTP 上傳功能開發</p>
<p>五、排程設定</p>
<p>確認任務清單後，開始設計程式結構：</p>
<p><strong>ods-wc-order-export/ods-wc-order-export.php</strong> - 外掛主要程式，用來設定常數與類別檔案引入</p>
<p><strong>ods-wc-order-export/js</strong> - 放後台可能會需要用到 Ajax 的 JS 檔</p>
<p><strong>ods-wc-order-export/class/class-ods-hook.php</strong> - 負責所有功能所需 Hook 掛載的類別</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-wc-admin.php</strong></strong> - 負責新增 WooCommerce 後台訂單介面的類別</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-wc-order.php</strong></strong> - 負責取得 WooCommerce 訂單資料的類別</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-csv.php</strong></strong> - 負責組成與匯出 csv 的類別</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-ftp.php</strong></strong> - 負責 FTP 上傳的類別</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-helper.php</strong></strong> - 負責工具類 class</p>
<h2 id="Let’s-Party-Start"><a href="#Let’s-Party-Start" class="headerlink" title="Let’s Party Start!"></a>Let’s Party Start!</h2><p>首先把可能未來會需要修改的資料定義為常數，讓接手的工程師方便些，如果更新頻率高且操作人員非工程師的話，建議還是把它做成後台的設定頁面會更友善些，定義的資料如下：</p>
<p><strong><strong>ods-wc-order-export/ods-wc-order-export.php</strong></strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * Plugin Name:       ODS WooCommerce Order Export
 * Plugin URI:        https://oberonlai.blog
 * Description:       WooCommerce 客製化報表自動匯出&amp;上傳功能
 * Version:           1.0.1
 * Author:            Oberon Lai
 * Author URI:        https://oberonlai.blog
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// WC 訂單傳送狀態欄位名稱</span>
<span class="token keyword">const</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'export_status'</span><span class="token punctuation">;</span>             

<span class="token comment">// WC 訂單傳送狀態欄位值</span>
<span class="token keyword">const</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'未傳送'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'已傳送'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'取消傳送'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// FTP 上傳資訊</span>
<span class="token keyword">const</span> <span class="token constant">ODS_WC_ORDER_EXPORT_TO_FTP</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'enable'</span>  <span class="token operator">=></span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 啟用/停用</span>
  <span class="token string single-quoted-string">'host'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'user'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'pass'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'path'</span>    <span class="token operator">=></span> <span class="token string single-quoted-string">'wp-content/uploads/'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 引入主要類別檔</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class/class-ods-hook.php'</span><span class="token punctuation">;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>ODS_WC_ORDER_EXPORT_META_KEY 為 Post Meta 的名稱，可以接受的值為 ODS_WC_ORDER_EXPORT_META_VALUE，我們會需要用到這裡面的值來判斷該訂單應該要做什麼樣的任務。</p>
<p>FTP 上傳資訊也是定義在這邊，可以設定是否要進行上傳以及上傳路徑，最後則是引入負責 Hook 的 class-ods-hook.php。如果未來有新的常數要定義都可以來這邊做新增。</p>
<p>接下來我們把鏡頭轉到 class-ods-hook.php，這個檔案負責三個任務，首先是引入需要用到的 class 檔，其次是把 WC 訂單傳送狀態欄位寫入，但也許網站已經經營一陣子了，所以會有既存的訂單資料，我們需要把傳送狀態欄位也寫入這些訂單。</p>
<p>最後是所有的 Hook，因為 Hook 會邊寫邊加，所以先把我們要做的任務先以註解的方式來標記，就能把整支外掛需要完成的功能做總覽，以便追蹤還有什麼功能沒有完成。</p>
<p><strong>ods-wc-order-export/class/class-ods-hook.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.引入 class
 * 2.訂單新增系統傳送狀態欄位，用來紀錄該訂單是否已被傳送至企業內部系統
 * 3.處理 Hooks
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-wc-admin.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-wc-order.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-csv.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-ftp.php'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ODS_Hook'</span> <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_Hook</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$plugin_version</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$wc_admin</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token comment">// 第一次啟用外掛時加入所有 WC 訂單的傳送狀態欄位</span>
      <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">plugin_version</span> <span class="token operator">=</span> <span class="token function">get_option</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ods_wc_order_export'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">plugin_version</span> <span class="token operator">==</span> <span class="token string single-quoted-string">''</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ods_wc_order_export'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'enable'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'init'</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$wc_admin</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_order_field'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'9999,1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      
      <span class="token comment">// 新訂單加入系統傳送狀態的 Post Meta</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token function">get_option</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ods_wc_order_export'</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'enable'</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'woocommerce_new_order'</span><span class="token punctuation">,</span><span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$wc_admin</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_order_field'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'1,1'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token variable">$erp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_Hook</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_WC_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>首先建立一個私有變數叫做 $plugin_version，用來紀錄該外掛是否是第一次啟用，如果是第一次的話，會在 wp_options 資料表裡面建立一個叫做 ods_wc_order_export 的欄位，其值為 enable，如果沒有欄位就代表是第一次啟用，然後在初始化的時候執行 set_order_field 這個方法。</p>
<p>set_order_field 可以帶一個參數，設定需要寫入的訂單筆數，在 add_action 最後一個參數 ‘9999,1’，這代表的是 set_order_field(9999)，然後因為只需帶一個參數所以第二個數字為 1。在第一次啟用外掛的狀況下可以帶入需要寫入系統傳送狀態的訂單筆數，之後新訂單只要抓最新的一筆就好，所以第 35 行最後的參數為 ‘1,1’。</p>
<p>set_order_field 實作細節在 class-ods-wc-admin.php：</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-wc-admin.php</strong></strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 處理後台系統傳送欄位註冊、介面顯示
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_WC_Admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_WC_Admin</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">/**
     * 新增訂單的系統傳送狀態欄位
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_order_field</span><span class="token punctuation">(</span> <span class="token variable">$num</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$args</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string single-quoted-string">'numberposts'</span> <span class="token operator">=></span> <span class="token variable">$num</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$wc_orders</span> <span class="token operator">=</span> <span class="token function">wc_get_orders</span><span class="token punctuation">(</span> <span class="token variable">$args</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$wc_orders</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$wc_orders</span> <span class="token keyword">as</span> <span class="token variable">$order</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token function">metadata_exists</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'post'</span><span class="token punctuation">,</span> <span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">update_post_meta</span><span class="token punctuation">(</span> <span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">0</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>set_order_field 主要是使用 wc_get_orders 來取得 WooCommerce 訂單，取得後先確認該訂單是否已經帶有系統傳送狀態的 Post Meta，沒有的話再利用 update_post_meta 進行狀態寫入的動作，如果需要篩選特定類型的訂單可以參考 WooCommerce 的 Github 頁面 –&gt; <a target="_blank" rel="noopener" href="https://github.com/woocommerce/woocommerce/wiki/wc_get_orders-and-WC_Order_Query#description">https://github.com/woocommerce/woocommerce/wiki/wc_get_orders-and-WC_Order_Query#description</a></p>
<h2 id="WooCommerce-後台訂單介面"><a href="#WooCommerce-後台訂單介面" class="headerlink" title="WooCommerce 後台訂單介面"></a>WooCommerce 後台訂單介面</h2><p>把基底搭建好了之後，我們先從後台介面來進行開發，根據需求我們新增以下三種功能：</p>
<p>一、訂單列表頁的表格增加系統傳送狀態的欄位</p>
<p>二、加入篩選功能，可以使用系統傳送狀態來篩選訂單</p>
<p>三、勾選訂單後的批次操作處理</p>
<p>我們會先把 Hook 定義好後再來發展細節，首先是增加訂單列表的表格欄位，一樣是編輯 class-ods-hook.php，在 function __construct 建構式裡面加入以下 Hook：</p>
<h3 id="一、訂單列表頁的表格增加系統傳送狀態的欄位"><a href="#一、訂單列表頁的表格增加系統傳送狀態的欄位" class="headerlink" title="一、訂單列表頁的表格增加系統傳送狀態的欄位"></a>一、訂單列表頁的表格增加系統傳送狀態的欄位</h3><p><strong>ods-wc-order-export/class/class-ods-hook.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token operator">...</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_Hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_Hook</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$plugin_version</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$wc_admin</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token operator">...</span>

      <span class="token comment">// WC 訂單列表頁表格加入標頭</span>
      <span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'manage_shop_order_posts_columns'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$wc_admin</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_admin_th'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token comment">// WC 訂單列表頁表格加入欄位</span>
      <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'manage_shop_order_posts_custom_column'</span> <span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$wc_admin</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_admin_columns'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token variable">$erp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_Hook</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_WC_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>manage_shop_order_posts_columns 與 manage_shop_order_posts_custom_column 是可以動態帶入 post type 的 Hook，寫法為 manage_{$post_type}_posts_columns，範例中 WooCommerce 訂單的 post type 為 shop_order，因此帶入 {$post_type} 即可，而該欄位只有在對應的 post type 下才會顯示。</p>
<p>set_admin_th 與 set_admin_columns 實作在 class-ods-wc-admin.php：</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-wc-admin.php</strong></strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 處理後台系統傳送欄位註冊、介面顯示
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_WC_Admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_WC_Admin</span> <span class="token punctuation">&#123;</span>
   
    <span class="token operator">...</span>
   
   <span class="token comment">/**
     * 註冊訂單列表系統傳送狀態顯示的標頭
     * 
     * @param array $columns 現有欄位
     * 
     * @return array $columns 新增欄位
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_admin_th</span><span class="token punctuation">(</span> <span class="token variable">$columns</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$columns</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'系統傳送狀態'</span><span class="token punctuation">;</span>    
      <span class="token keyword">return</span> <span class="token variable">$columns</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 註冊訂單列表的系統傳送狀態顯示
     * 
     * @param string $column_name 欄位名稱
     * @param int $post_id 訂單 ID
     * 
     * @return string $send_status 訂單系統傳送狀態顯示文字
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_admin_columns</span><span class="token punctuation">(</span> <span class="token variable">$column_name</span><span class="token punctuation">,</span> <span class="token variable">$post_id</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span> <span class="token variable">$column_name</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string single-quoted-string">'send_status'</span><span class="token punctuation">:</span>
          <span class="token variable">$order</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WC_Order</span><span class="token punctuation">(</span> <span class="token variable">$post_id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">echo</span> <span class="token variable">$send_status</span> <span class="token operator">=</span> <span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_meta</span><span class="token punctuation">(</span><span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>  
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>set_admin_th 新增欄位叫做 send_status，賦予的值也就是在後台看到的標頭名稱叫做「系統傳送狀態」，set_admin_columns 則用 switch 判斷當欄位名稱叫做 send_status 的時候，去取得該 post 的 post meta，就能把資料顯示出來，完成後如下圖：</p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.14.48.jpg"></p>
<p>其次是加入篩選功能，並將系統傳送狀態的值加入到搜尋結果，這樣就能提供後台操作人員快速篩選出需要的訂單，以便後續的訂單處理，先回到 class-ods-hook.php 來加入繼續 Hook：</p>
<h3 id="二、加入篩選功能，可以使用系統傳送狀態來篩選訂單"><a href="#二、加入篩選功能，可以使用系統傳送狀態來篩選訂單" class="headerlink" title="二、加入篩選功能，可以使用系統傳送狀態來篩選訂單"></a>二、加入篩選功能，可以使用系統傳送狀態來篩選訂單</h3><p><strong>ods-wc-order-export/class/class-ods-hook.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token operator">...</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_Hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_Hook</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$plugin_version</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$wc_admin</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token operator">...</span>

      <span class="token comment">// 訂單搜尋功能加入系統傳送狀態關鍵字索引</span>
      <span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'woocommerce_shop_order_search_fields'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$wc_admin</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_status_seach'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">100</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token variable">$erp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_Hook</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_WC_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>負責搜尋功能索引的 filter 是 woocommerce_shop_order_search_fields，set_status_seach 實作細節在 class-ods-wc-admin.php</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-wc-admin.php</strong></strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 處理後台系統傳送欄位註冊、介面顯示
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_WC_Admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_WC_Admin</span> <span class="token punctuation">&#123;</span>
   
    <span class="token operator">...</span>
   
   <span class="token comment">/**
     * 訂單列表加入可搜尋系統傳送狀態關鍵字功能
     * 
     * @param array $serach_fields 搜尋欄位
     * 
     * @return array $search_fields 加入系統傳送搜尋狀態的欄位
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_status_seach</span><span class="token punctuation">(</span><span class="token variable">$search_fields</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$search_fields</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token variable">$search_fields</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>把 post meta 的 Key 存進 $search_fields 陣列，就能如下圖透過搜尋功能進行搜尋：</p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.27.22.jpg"></p>
<p>接下來回到 class-ods-hook.php 來處理篩選下拉選單：</p>
<p><strong>ods-wc-order-export/class/class-ods-hook.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token operator">...</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_Hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_Hook</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$plugin_version</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$wc_admin</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token operator">...</span>

     <span class="token comment">// 訂單篩選下拉選單</span>
      <span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'restrict_manage_posts'</span><span class="token punctuation">,</span>  <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$wc_admin</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_status_filter'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">20</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'parse_query'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$wc_admin</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'get_status_filter_result'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">99</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token variable">$erp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_Hook</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_WC_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>第一個 action restrict_manager_posts 為篩選訂單列表的顯示狀態，第二個 filter parse_query 為處理網址帶入的篩選參數，當 parese_query 傳送參數後，WordPress 會透過 restrict_manager_posts 來取得符合條件的資料，set_status_filter 與 get_status_filter_result 實作細節一樣在 class-ods-wc-admin.php</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-wc-admin.php</strong></strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 處理後台系統傳送欄位註冊、介面顯示
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_WC_Admin'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_WC_Admin</span> <span class="token punctuation">&#123;</span>
   
    <span class="token operator">...</span>
   
   <span class="token comment">/**
     * 訂單列表加入系統傳送狀態查詢下拉選單
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_status_filter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">global</span> <span class="token variable">$typenow</span><span class="token punctuation">;</span>
      <span class="token keyword">global</span> <span class="token variable">$wp_query</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token variable">$typenow</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'shop_order'</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> 
          <span class="token variable">$plugins</span> <span class="token operator">=</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span><span class="token punctuation">;</span>
          <span class="token variable">$current_plugin</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status'</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token variable">$current_plugin</span> <span class="token operator">=</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status'</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
          <span class="token punctuation">&#125;</span> <span class="token delimiter important">?></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>send_status<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>send_status<span class="token punctuation">"</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token style language-css"><span class="token property">width</span><span class="token punctuation">:</span> 200px<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>all<span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">selected</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'all'</span><span class="token punctuation">,</span> <span class="token variable">$current_plugin</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></span><span class="token punctuation">></span></span>系統傳送狀態（所有）<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
            <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">foreach</span><span class="token punctuation">(</span> <span class="token variable">$plugins</span> <span class="token keyword">as</span> <span class="token variable">$key</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token delimiter important">?></span></span>
              <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">esc_attr</span><span class="token punctuation">(</span> <span class="token variable">$key</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">selected</span><span class="token punctuation">(</span> <span class="token variable">$key</span><span class="token punctuation">,</span> <span class="token variable">$current_plugin</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span></span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">esc_attr</span><span class="token punctuation">(</span> <span class="token variable">$key</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
            <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">&#125;</span> <span class="token delimiter important">?></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
      <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 訂單列表取得系統傳送狀態查詢結果
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">get_status_filter_result</span><span class="token punctuation">(</span> <span class="token variable">$query</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">global</span> <span class="token variable">$pagenow</span><span class="token punctuation">;</span>
      <span class="token variable">$post_type</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'post_type'</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'post_type'</span>\<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">is_admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$pagenow</span><span class="token operator">==</span><span class="token string single-quoted-string">'edit.php'</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$post_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'shop_order'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status'</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status'</span>\<span class="token punctuation">]</span> <span class="token operator">!=</span><span class="token string single-quoted-string">'all'</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$query</span><span class="token operator">-></span><span class="token property">query_vars</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'post_status'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'all'</span><span class="token punctuation">;</span>
        <span class="token variable">$query</span><span class="token operator">-></span><span class="token property">query_vars</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'meta_key'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span><span class="token punctuation">;</span>
        <span class="token variable">$query</span><span class="token operator">-></span><span class="token property">query_vars</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'meta_value'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status'</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$query</span><span class="token operator">-></span><span class="token property">query_vars</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'meta_compare'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'='</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>set_status_filter 增加一組下拉選單，選項內容為系統傳送狀態的文字，並將選取到的值透過 $_GET 方式進行傳送，get_status_filter_result 則處理資料顯示，根據從 set_status_filter 傳出來的 $_GET[‘send_status’] 來進行比對，比對方式為完全符合，參考第 48 行 $query-&gt;query_vars[‘meta_compare’] = ‘=’ 。</p>
<p>完成後的介面如下：</p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.40.58.jpg"></p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-11.41.16.jpg"></p>
<h3 id="三、勾選訂單後的批次操作處理"><a href="#三、勾選訂單後的批次操作處理" class="headerlink" title="三、勾選訂單後的批次操作處理"></a>三、勾選訂單後的批次操作處理</h3><p>後台介面最後要處理的動作，就是當使用批次操作時可以改變系統傳送狀態，我們需要先新增操作的動作，然後根據選到的動作來進行相對應的處理方式，一樣把需要的 Hook 先掛好：</p>
<p><strong>ods-wc-order-export/class/class-ods-hook.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token operator">...</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_Hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_Hook</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$plugin_version</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$wc_admin</span><span class="token punctuation">,</span> <span class="token variable">$csv</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token operator">...</span>

      <span class="token comment">// 訂單批次操作加入新動作</span>
      <span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'bulk_actions-edit-shop_order'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$csv</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_send_custom_bulk_actions'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'handle_bulk_actions-edit-shop_order'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$csv</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_send_custom_bulk_actions_handler'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">3</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'admin_notices'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token variable">$csv</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'set_send_custom_bulk_actions_notice'</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token number">20</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token variable">$erp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_Hook</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_WC_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_CSV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>因為批次操作會關係到 csv 的產出作業，所以我們用了新類別 ODS_CSV，並宣告物件 $csv，bulk_actions-edit-shop_order 是加入新的批次操作動作，handle_bulk_actions-edit-shop_order 是處理對應的動作，這兩個 filter 最後帶的都是 post type，所以可以根據需要動態置換 Hook 名稱。</p>
<p>admin_notices 是批次操作結束後所顯示的提示訊息，用來告知管理員處理狀態，稍後我們也會做訂傳送狀態的驗證判斷，像是要把訂單變成已傳送必須是未傳送的訂單，透過 admin_notices 就可以提醒管理員為何變更失敗或成功。</p>
<p>接下來的實作細節在 class-ods-csv.php</p>
<p><strong>ods-wc-order-export/class/class-ods-csv.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.設定批次操作要執行的動作
 * 2.組合 CSV 欄位
 * 3.執行 FTP 上傳
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_CSV'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_CSV</span> <span class="token punctuation">&#123;</span>

     <span class="token comment">/**
     * 訂單列表加入系統傳送狀態批次操作項目
     * 
     * @param array $bulk_actions 現有操作項目
     * 
     * @return array $bulk_actions 新增操作項目
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_custom_bulk_actions</span><span class="token punctuation">(</span> <span class="token variable">$bulk_actions</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$bulk_actions</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_to_cancel'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'將系統傳送狀態變更為'</span><span class="token operator">.</span><span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">1</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token variable">$bulk_actions</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_to_delivered'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'將系統傳送狀態變更為'</span><span class="token operator">.</span><span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">2</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token variable">$bulk_actions</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 訂單列表系統傳送批次操作項目點選後要做的事
     * 
     * @param string $redirect_to 跳轉頁面
     * @param string $doaction 操作項目代稱
     * @param array $post_ids 被勾選的訂單 ID
     * 
     * @return string $redirect_to 操作完成後跳轉的頁面
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_custom_bulk_actions_handler</span><span class="token punctuation">(</span> <span class="token variable">$redirect_to</span><span class="token punctuation">,</span> <span class="token variable">$doaction</span><span class="token punctuation">,</span> <span class="token variable">$post_ids</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$doaction</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string single-quoted-string">'send_to_cancel'</span><span class="token punctuation">:</span>
          <span class="token comment">// 變為已傳送要做的事</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string single-quoted-string">'send_to_delivered'</span><span class="token punctuation">:</span>
          <span class="token comment">// 變為取消傳送要做的事</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token comment"># code...</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token variable">$redirect_to</span><span class="token punctuation">;</span>
     
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 訂單列表顯示系統傳送狀態變更完成後的訊息
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_custom_bulk_actions_notice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span> <span class="token delimiter important">?></span></span>
      <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status_text'</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span> <span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status_changed'</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'error'</span> <span class="token operator">===</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status_changed'</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notice notice-error is-dismissible<span class="token punctuation">"</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token style language-css"><span class="token property">display</span><span class="token punctuation">:</span>block<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status_text'</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">else</span><span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>notice notice-success is-dismissible<span class="token punctuation">"</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token style language-css"><span class="token property">display</span><span class="token punctuation">:</span>block<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
          <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$_GET</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_status_text'</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
        <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
      <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
    <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token punctuation">&#125;</span>    

  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>使用 set_send_custom_bulk_actions 加入兩個新的批次操作動作，然後 set_send_custom_bulk_actions_handler 就可以根據選擇的動作進行事件的處理。set_send_custom_bulk_actions_notice 提示文字稍後會再補上，主要是用兩個參數 send_status_text 與 send_status_changed 來決定是否顯示以及提示文字內容。</p>
<p>加入批次操作後介面如下圖：</p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-08-at-12.36.54.jpg"></p>
<p>後台的介面設計差不多這樣就算完成了，接下來是處理 WooCommerce 訂單資料。</p>
<h2 id="WooCommerce-訂單資料取得"><a href="#WooCommerce-訂單資料取得" class="headerlink" title="WooCommerce 訂單資料取得"></a>WooCommerce 訂單資料取得</h2><p>為了方便取得 WooCommerce 訂單資料，我們另外寫一支 class-ods-wc-order.php 來處理，除了訂單本身的資料外，還可以把需要計算或是組合資料的先在這邊處理，讓 class-ods-csv.php 專注在組合 csv。</p>
<p>這支類別包含了訂單的五個部分：基本資料、商品明細、運費資料、稅務資料費用資料與折價券資料，完整原始碼為參考 Web Hat 的 <a target="_blank" rel="noopener" href="https://www.webhat.in/article/woocommerce-tutorial/how-to-get-order-details-by-order-id/">How to Get Order Details by Order ID</a> 這篇教學，改寫為 class 後節錄如下：</p>
<p><strong><strong>ods-wc-order-export/class/class-ods-wc-order.php</strong></strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>


<span class="token comment">/**
 * 取得訂單資訊
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_WC_Order'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_WC_Order</span> <span class="token punctuation">&#123;</span>

    <span class="token comment">/**
 * 取得訂單內容
 *
 * @param int $id 訂單 post id
 * @param string $field 訂單主要欄位名稱
 * @param string $subfield 訂單次要欄位名稱
 * 
 * @return array $order_data 訂單資料
 */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">,</span> <span class="token variable">$field</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$subfield</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">,</span> <span class="token variable">$filter</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_wp_error</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

<span class="token variable">$dp</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$filter</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'dp'</span>\<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$filter</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'dp'</span>\<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token variable">$order</span> <span class="token operator">=</span> <span class="token function">wc_get_order</span><span class="token punctuation">(</span><span class="token variable">$id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$order</span> <span class="token operator">===</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">// 基本資料</span>
<span class="token variable">$order_data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'order_number'</span> <span class="token operator">=></span> <span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_order_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'created_at'</span> <span class="token operator">=></span> <span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_date_created</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-></span><span class="token function">date</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Y-m-d'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token operator">...</span>
        <span class="token comment">// 略</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_items</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$item_id</span> <span class="token operator">=></span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$product</span> <span class="token operator">=</span> <span class="token variable">$item</span><span class="token operator">-></span><span class="token function">get_product</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$product_id</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token variable">$product_sku</span> <span class="token operator">=</span> <span class="token constant">null</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">is_object</span><span class="token punctuation">(</span><span class="token variable">$product</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$product_id</span> <span class="token operator">=</span> <span class="token variable">$product</span><span class="token operator">-></span><span class="token function">get_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$product_sku</span> <span class="token operator">=</span> <span class="token variable">$product</span><span class="token operator">-></span><span class="token function">get_sku</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>


<span class="token comment">// 商品資料</span>
<span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'line_items'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token variable">$item_id</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'subtotal'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_line_subtotal</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'subtotal_tax'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'line_subtotal_tax'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'total'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_line_total</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'total_tax'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'line_tax'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'price'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_item_total</span><span class="token punctuation">(</span><span class="token variable">$item</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token operator">...</span>
        <span class="token comment">// 略</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">&#125;</span>

<span class="token comment">// 運費資料</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_shipping_methods</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$shipping_item_id</span> <span class="token operator">=></span> <span class="token variable">$shipping_item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'shipping_lines'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'id'</span>  <span class="token operator">=></span> <span class="token variable">$shipping_item_id</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'method_id'</span> <span class="token operator">=></span> <span class="token variable">$shipping_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'method_id'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'method_title'</span> <span class="token operator">=></span> <span class="token variable">$shipping_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'total'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$shipping_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'cost'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 税相關資料</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_tax_totals</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$tax_code</span> <span class="token operator">=></span> <span class="token variable">$tax</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'tax_lines'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token variable">$tax</span><span class="token operator">-></span><span class="token property">id</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'rate_id'</span> <span class="token operator">=></span> <span class="token variable">$tax</span><span class="token operator">-></span><span class="token property">rate_id</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'code'</span> <span class="token operator">=></span> <span class="token variable">$tax_code</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'title'</span> <span class="token operator">=></span> <span class="token variable">$tax</span><span class="token operator">-></span><span class="token property">label</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'total'</span><span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$tax</span><span class="token operator">-></span><span class="token property">amount</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'compound'</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token keyword type-casting">bool</span><span class="token punctuation">)</span> <span class="token variable">$tax</span><span class="token operator">-></span><span class="token property">is_compound</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 費用資料</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_fees</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$fee_item_id</span> <span class="token operator">=></span> <span class="token variable">$fee_item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'fee_lines'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token variable">$fee_item_id</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'title'</span> <span class="token operator">=></span> <span class="token variable">$fee_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'tax_class'</span> <span class="token operator">=></span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$fee_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'tax_class'</span>\<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token variable">$fee_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'tax_class'</span>\<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token constant">null</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'total'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_line_total</span><span class="token punctuation">(</span><span class="token variable">$fee_item</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'total_tax'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_line_tax</span><span class="token punctuation">(</span><span class="token variable">$fee_item</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 折價券資料</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_items</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'coupon'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$coupon_item_id</span> <span class="token operator">=></span> <span class="token variable">$coupon_item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'coupon_lines'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'id'</span> <span class="token operator">=></span> <span class="token variable">$coupon_item_id</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'code'</span> <span class="token operator">=></span> <span class="token variable">$coupon_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'name'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'amount'</span> <span class="token operator">=></span> <span class="token function">wc_format_decimal</span><span class="token punctuation">(</span><span class="token variable">$coupon_item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'discount_amount'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$dp</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$field</span> <span class="token operator">===</span> <span class="token string single-quoted-string">'line_items'</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token variable">$line_items</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$i</span><span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$order</span><span class="token operator">-></span><span class="token function">get_items</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$item_id</span> <span class="token operator">=></span> <span class="token variable">$item</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$line_items</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token variable">$field</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span><span class="token variable">$i</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span><span class="token variable">$subfield</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token variable">$line_items</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token variable">$subfield</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token variable">$field</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span><span class="token variable">$subfield</span>\<span class="token punctuation">]</span><span class="token punctuation">:</span><span class="token variable">$order_data</span>\<span class="token punctuation">[</span><span class="token variable">$field</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>等下在 class-ods-csv.php 裡面就可以使用 ODS_WC_Order::get_order_detail 來取得訂單資料。</p>
<h2 id="匯出-csv-檔與-FTP-上傳"><a href="#匯出-csv-檔與-FTP-上傳" class="headerlink" title="匯出 csv 檔與 FTP 上傳"></a>匯出 csv 檔與 FTP 上傳</h2><p>準備好訂單資料，接下來就是開始整理要輸出的 csv 檔，當訂單的系統傳送狀態變更為已傳送與取消傳送時，都需要執行匯出的動作，我們先處理匯出 csv 的細節，也就是組合訂單資料，我們先定義好資料的標頭，然後使用商品名稱來依序輸出：</p>
<h3 id="整理-csv-欄位"><a href="#整理-csv-欄位" class="headerlink" title="整理 csv 欄位"></a>整理 csv 欄位</h3><p><strong>ods-wc-order-export/class/class-ods-csv.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.設定批次操作要執行的動作
 * 2.組合 CSV 欄位
 * 3.執行 FTP 上傳
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_CSV'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_CSV</span> <span class="token punctuation">&#123;</span>

    <span class="token operator">...</span>
    
    <span class="token comment">/**
     * 傳送訂單到 send
     * 
     * @param array $post_ids 要傳送的訂單 post ID
     * @param string $send_stauts 此次傳送處理的動作
     * @param string $send_status 傳送後的狀態
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_transfer</span><span class="token punctuation">(</span><span class="token variable">$post_ids</span><span class="token punctuation">,</span> <span class="token variable">$send_status</span><span class="token punctuation">,</span> <span class="token variable">$send_status_update</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token comment">//設定系統環境，確保輸出執行環境無礙</span>
      <span class="token function">set_time_limit</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">//開始準備一組匯出陣列</span>
      <span class="token variable">$csv_arr</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">//先放置 CSV 檔案的標頭資料</span>
      <span class="token variable">$csv_arr</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'訂購人'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'訂購人電話'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'訂單編號'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'收貨人'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'下單時間'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'商品編號'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'商品名稱'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'商品數量'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'訂單金額'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'運費'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'送貨郵遞區號'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'送貨地址'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'原售價'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'商品售價'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'付款方式'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">//設定檔案輸出名稱</span>
      <span class="token variable">$filename</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"order-export_"</span> <span class="token operator">.</span> <span class="token function">current_time</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"YmdHis"</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">".csv"</span><span class="token punctuation">;</span>
      <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Pragma: no-cache'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'Expires: 0'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token variable">$order_data</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$count</span> <span class="token operator">=</span> <span class="token variable">$amount</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
      <span class="token variable">$i</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$post_ids</span> <span class="token keyword">as</span> <span class="token variable">$post_id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  
        <span class="token variable">$order_data</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
          <span class="token string single-quoted-string">'billing_last_name'</span>   <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'billing_address'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'last_name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'billing_phone'</span>       <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'billing_address'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'phone'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'order_id'</span>            <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'order_number'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'shipping_last_name'</span>  <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'shipping_address'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'last_name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'order_date'</span>          <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'created_at'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'sku'</span>                 <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'line_items'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'sku'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'product_name'</span>        <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'line_items'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'quantity'</span>            <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'line_items'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'quantity'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'order_total'</span>         <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'total'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'shipping_cost'</span>       <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'total_shipping'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'biiling_postcode'</span>    <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'billing_address'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'postcode'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'shipping_address'</span>    <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'taiwan_address'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'regular_price'</span>       <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'line_items'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'regular_price'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'payment_method'</span>      <span class="token operator">=></span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'payment_details'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'method_title'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$i</span><span class="token operator">++</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token keyword">foreach</span><span class="token punctuation">(</span> <span class="token variable">$order_data</span> <span class="token keyword">as</span> <span class="token variable">$item</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$j</span> <span class="token operator">=</span> <span class="token variable">$n</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

        <span class="token comment">/**
         * 組 csv row
         */</span>
        <span class="token keyword">foreach</span><span class="token punctuation">(</span> <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'product_name'</span>\<span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$name</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
          <span class="token variable">$csv_arr</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'billing_last_name'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'billing_phone'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'order_id'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'shipping_last_name'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'order_date'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'sku'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span><span class="token variable">$j</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$name</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'quantity'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span><span class="token variable">$j</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'order_total'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'shipping_cost'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'biiling_postcode'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'shipping_address'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'regular_price'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span><span class="token variable">$j</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'regular_price'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span><span class="token variable">$j</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token variable">$item</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'payment_method'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 正式循環輸出陣列內容</span>
      <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token string single-quoted-string">''</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token variable">$j</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token variable">$j</span> <span class="token operator">&lt;</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$csv_arr</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token variable">$j</span><span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$content</span> <span class="token operator">.=</span> <span class="token class-name static-context">ODS_Helper</span><span class="token operator">::</span><span class="token function">csvstr</span><span class="token punctuation">(</span><span class="token variable">$csv_arr</span>\<span class="token punctuation">[</span><span class="token variable">$j</span>\<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">.</span><span class="token string double-quoted-string">"\\n"</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>

      <span class="token comment">// 把 csv 寫入 wp-content/uploads</span>
      <span class="token variable">$upload_dir</span> <span class="token operator">=</span> <span class="token function">wp_upload_dir</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">file_put_contents</span><span class="token punctuation">(</span> <span class="token variable">$upload_dir</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'basedir'</span>\<span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'/send/'</span><span class="token operator">.</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">,</span> <span class="token constant">FILE_APPEND</span>  <span class="token constant">LOCK_EX</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>set_send_transfer 主要負責 csv 的欄位整理，接受三個參數，分別是被勾選的訂單 ID，訂單未處理前跟處理後要變更的系統傳送狀態，這在稍後會用來驗證訂單是否為正確的傳送狀態，驗證過才能進行變更。</p>
<h3 id="指定給批次操作對應動作"><a href="#指定給批次操作對應動作" class="headerlink" title="指定給批次操作對應動作"></a>指定給批次操作對應動作</h3><p>到這邊匯出 csv 的動作就完成了，接下來我們要把它指派給批次操作的動作，另外還要做訂單驗證以免重複傳送已傳送的訂單。</p>
<p><strong>ods-wc-order-export/class/class-ods-csv.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.設定批次操作要執行的動作
 * 2.組合 CSV 欄位
 * 3.執行 FTP 上傳
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_CSV'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_CSV</span> <span class="token punctuation">&#123;</span>

     <span class="token operator">...</span>
       
     <span class="token comment">/**
     * 訂單列表改變系統傳送顯示狀態
     * 
     * @param array $post_ids 有被勾選到的訂單 ID
     * 
     * @return string $status 送出完成後的新狀態
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update_send_status</span><span class="token punctuation">(</span> <span class="token variable">$post_ids</span><span class="token punctuation">,</span> <span class="token variable">$status</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$post_ids</span> <span class="token keyword">as</span> <span class="token variable">$post_id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">update_post_meta</span><span class="token punctuation">(</span> <span class="token variable">$post_id</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span><span class="token punctuation">,</span> <span class="token variable">$status</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">/**
     * 取得選取訂單的系統傳送狀態
     * 
     * @param array $post_ids 有被勾選到的訂單 ID
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">get_send_status</span><span class="token punctuation">(</span><span class="token variable">$post_ids</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$send_stauts_array</span> <span class="token operator">=</span> \<span class="token punctuation">[</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$post_ids</span> <span class="token keyword">as</span> <span class="token variable">$post_id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$send_stauts_array</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token class-name static-context">ODS_WC_Order</span><span class="token operator">::</span><span class="token function">get_order_detail</span><span class="token punctuation">(</span><span class="token variable">$post_id</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'send_status'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token variable">$send_stauts_array</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
       
     <span class="token comment">/**
     * 判斷狀態送出後的頁面跳轉要做的事
     * 
     * @param array $post_ids 有被勾選到的訂單 ID
     * @param string $send_status_before 訂單更新前的系統傳送狀態
     * @param string $send_status_updated 訂單更新後的系統傳送狀態
     * @param string $redirect 跳轉網址
     * 
     * @return string $redirect 返回更新狀態判斷與顯示文字
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">function</span> <span class="token function">set_send_custom_bulk_actions_redirect</span><span class="token punctuation">(</span> <span class="token variable">$post_ids</span><span class="token punctuation">,</span> <span class="token variable">$send_status_before</span><span class="token punctuation">,</span> <span class="token variable">$send_stauts_updated</span><span class="token punctuation">,</span> <span class="token variable">$redirect</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">count</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">get_send_status</span><span class="token punctuation">(</span><span class="token variable">$post_ids</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> <span class="token function">end</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-></span><span class="token function">get_send_status</span><span class="token punctuation">(</span><span class="token variable">$post_ids</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token variable">$send_status_before</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_send_transfer</span><span class="token punctuation">(</span> <span class="token variable">$post_ids</span><span class="token punctuation">,</span> <span class="token variable">$send_status_before</span><span class="token punctuation">,</span> <span class="token variable">$csv_filename</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">update_send_status</span><span class="token punctuation">(</span> <span class="token variable">$post_ids</span><span class="token punctuation">,</span><span class="token variable">$send_stauts_updated</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$redirect</span> <span class="token operator">=</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'send_status_text'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'所有選取訂單之系統傳送狀態變更完成！'</span><span class="token punctuation">,</span> <span class="token variable">$redirect</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$redirect</span> <span class="token operator">=</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'send_status_changed'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'success'</span><span class="token punctuation">,</span> <span class="token variable">$redirect</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$redirect</span> <span class="token operator">=</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'send_status_text'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'系統傳送狀態變更失敗，所有選取訂單之系統傳送狀態應皆為「'</span><span class="token operator">.</span><span class="token variable">$send_status_before</span><span class="token operator">.</span><span class="token string single-quoted-string">'」！'</span><span class="token punctuation">,</span> <span class="token variable">$redirect</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$redirect</span> <span class="token operator">=</span> <span class="token function">add_query_arg</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'send_status_changed'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'error'</span><span class="token punctuation">,</span> <span class="token variable">$redirect</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token variable">$redirect</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
       
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>set_send_custom_bulk_actions_redirect 帶四個參數，分別是被勾選的訂單 ID、變更前與變更後的傳送壯台，以及變更後的跳轉網址。</p>
<p>首先先判斷被勾選訂單的系統傳送狀態是否都一樣，然後這個狀態要符合變更前的系統傳送狀態，條件都成立後才進行 set_send_transfer 的動作，執行完成後使用 update_send_status 來改變訂單的傳送狀態，最後兩個 add_qeury_arg 是提供給 admin_notice 用的顯示判斷，用來告知後台操作人員系統傳送狀態的變更結果。</p>
<p>最後我們回到前面的 set_send_custom_bulk_actions_handler，把 set_send_custom_bulk_actions_redirect 帶入對應的參數指派給選擇到的操作：</p>
<p><strong>ods-wc-order-export/class/class-ods-csv.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.設定批次操作要執行的動作
 * 2.組合 CSV 欄位
 * 3.執行 FTP 上傳
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_CSV'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_CSV</span> <span class="token punctuation">&#123;</span>

     <span class="token comment">/**
     * 訂單列表加入系統傳送狀態批次操作項目
     * 
     * @param array $bulk_actions 現有操作項目
     * 
     * @return array $bulk_actions 新增操作項目
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_custom_bulk_actions</span><span class="token punctuation">(</span> <span class="token variable">$bulk_actions</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$bulk_actions</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_to_cancel'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'將系統傳送狀態變更為'</span><span class="token operator">.</span><span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">1</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token variable">$bulk_actions</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'send_to_delivered'</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'將系統傳送狀態變更為'</span><span class="token operator">.</span><span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">2</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token variable">$bulk_actions</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 訂單列表系統傳送批次操作項目點選後要做的事
     * 
     * @param string $redirect_to 跳轉頁面
     * @param string $doaction 操作項目代稱
     * @param array $post_ids 被勾選的訂單 ID
     * 
     * @return string $redirect_to 操作完成後跳轉的頁面
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_custom_bulk_actions_handler</span><span class="token punctuation">(</span> <span class="token variable">$redirect_to</span><span class="token punctuation">,</span> <span class="token variable">$doaction</span><span class="token punctuation">,</span> <span class="token variable">$post_ids</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token variable">$doaction</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">case</span> <span class="token string single-quoted-string">'send_to_cancel'</span><span class="token punctuation">:</span>
          <span class="token comment">// 變為已傳送要做的事</span>
          <span class="token variable">$redirect_to</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_send_custom_bulk_actions_redirect</span><span class="token punctuation">(</span> <span class="token variable">$post_ids</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">0</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">1</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$redirect_to</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token string single-quoted-string">'send_to_delivered'</span><span class="token punctuation">:</span>
          <span class="token comment">// 變為取消傳送要做的事</span>
          <span class="token variable">$redirect_to</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_send_custom_bulk_actions_redirect</span><span class="token punctuation">(</span> <span class="token variable">$post_ids</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">1</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">2</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$redirect_to</span> <span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
          <span class="token comment"># code...</span>
          <span class="token keyword">break</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token variable">$redirect_to</span><span class="token punctuation">;</span>
     
    <span class="token punctuation">&#125;</span>
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>補上 case 為 send_to_cancel 與 send_to_delivered 的實作細節，也就是呼叫 set_send_custom_bulk_actions_redirect，這樣就完成了執行批次操作後，csv 檔匯出到 wp-content/uploads/send 資料夾的功能了！</p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/07/CleanShot-2020-07-09-at-11.03.29-1024x319.jpg"></p>
<h3 id="FTP-上傳"><a href="#FTP-上傳" class="headerlink" title="FTP 上傳"></a>FTP 上傳</h3><p>因為是要整合客戶的內部系統，所以必須把我們整理好的 csv 檔上傳到第三方主機上，這次使用的是 FTP 上傳方式，為了方便日後重複使用，另外寫一支 class-ods-ftp.php 來處理 FTP 的上傳功能，加入後只要在 class-ods-csv.php 直接使用即可。</p>
<p><strong>ods-wc-order-export/class/class-ods-ftp.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * FTP 作業
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_FTP'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_FTP</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$host</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token comment">//遠端伺服器地址</span>
    <span class="token keyword">private</span> <span class="token variable">$user</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token comment">//ftp使用者名稱</span>
    <span class="token keyword">private</span> <span class="token variable">$pass</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token comment">//ftp密碼</span>
    <span class="token keyword">private</span> <span class="token variable">$port</span><span class="token operator">=</span><span class="token number">21</span><span class="token punctuation">;</span><span class="token comment">//ftp登入埠</span>
    <span class="token keyword">private</span> <span class="token variable">$error</span><span class="token operator">=</span><span class="token string single-quoted-string">''</span><span class="token punctuation">;</span><span class="token comment">//最後失敗時的錯誤資訊</span>
    <span class="token keyword">protected</span> <span class="token variable">$conn</span><span class="token punctuation">;</span><span class="token comment">//ftp登入資源</span>

    <span class="token comment">/**
     * 可以在例項化類的時候配置資料，也可以在下面的connect方法中配置資料
     * Ftp constructor.
     * @param array $config
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$config</span><span class="token operator">=</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">)</span> <span class="token keyword">OR</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">/**
     * 初始化資料
     * @param array $config 配置檔案陣列
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">initialize</span><span class="token punctuation">(</span><span class="token keyword type-hint">array</span> <span class="token variable">$config</span><span class="token operator">=</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">host</span> <span class="token operator">=</span> <span class="token variable">$config</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">user</span> <span class="token operator">=</span> <span class="token variable">$config</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">pass</span> <span class="token operator">=</span> <span class="token variable">$config</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span>\<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-></span><span class="token property">port</span> <span class="token operator">=</span> <span class="token keyword">isset</span><span class="token punctuation">(</span><span class="token variable">$config</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'port'</span>\<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token punctuation">:</span> <span class="token number">21</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    
    <span class="token comment">// 以下略</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>FTP 的帳密設定在外掛的主要檔案 ods-wc-order-export.php 裡面，接下來回到 class-ods-csv.php 裡面的 set_send_transfer 方法，在最下面把 FTP 上傳加進去：</p>
<p><strong>ods-wc-order-export/class/class-ods-csv.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.設定批次操作要執行的動作
 * 2.組合 CSV 欄位
 * 3.執行 FTP 上傳
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_CSV'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_CSV</span> <span class="token punctuation">&#123;</span>

    <span class="token operator">...</span>
    
    <span class="token comment">/**
     * 傳送訂單到 send
     * 
     * @param array $post_ids 要傳送的訂單 post ID
     * @param string $send_stauts 此次傳送處理的動作
     * @param string $send_status 傳送後的狀態
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_transfer</span><span class="token punctuation">(</span><span class="token variable">$post_ids</span><span class="token punctuation">,</span> <span class="token variable">$send_status</span><span class="token punctuation">,</span> <span class="token variable">$send_status_update</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token operator">...</span>
        
      <span class="token comment">// FTP 上傳作業</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token constant">ODS_FTP_DATA</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'enable'</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token variable">$config</span> <span class="token operator">=</span> \<span class="token punctuation">[</span>
          <span class="token string single-quoted-string">'host'</span><span class="token operator">=></span><span class="token constant">ODS_FTP_DATA</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'host'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'user'</span><span class="token operator">=></span><span class="token constant">ODS_FTP_DATA</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'user'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'pass'</span><span class="token operator">=></span><span class="token constant">ODS_FTP_DATA</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'pass'</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span>
        \<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token variable">$ftp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_FTP</span><span class="token punctuation">(</span><span class="token variable">$config</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$result</span> <span class="token operator">=</span> <span class="token variable">$ftp</span><span class="token operator">-></span><span class="token function">connect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$local_file</span> <span class="token operator">=</span> <span class="token variable">$upload_dir</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'basedir'</span>\<span class="token punctuation">]</span><span class="token operator">.</span><span class="token string single-quoted-string">'/send/'</span><span class="token operator">.</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token variable">$remote_file</span> <span class="token operator">=</span> <span class="token constant">ODS_FTP_DATA</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'path'</span>\<span class="token punctuation">]</span><span class="token operator">.</span><span class="token variable">$filename</span><span class="token punctuation">;</span>
        <span class="token variable">$ftp</span><span class="token operator">-></span><span class="token function">upload</span><span class="token punctuation">(</span><span class="token variable">$local_file</span><span class="token punctuation">,</span><span class="token variable">$remote_file</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'ascii'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
    
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>指定 wp-content/uploads/send/.csv 來進行上傳，這樣一來當匯出完成後就能自動上傳到遠端主機。</p>
<h2 id="排程設定"><a href="#排程設定" class="headerlink" title="排程設定"></a>排程設定</h2><p>完成手動的操作之後，使用 wp-cron 排程就能讓上述全部動作自動化，只要在固定時間呼叫 class-ods-csv.php 的 set_send_custom_bulk_actions_redirect 方法就能完成了，wp-cron 設定包含三個步驟：外掛啟用時註冊排程 Hook 名稱、把要做的任務掛到這個 Hook 上、外掛停用時取消排程 Hook。</p>
<h3 id="註冊排程-Hook-名稱"><a href="#註冊排程-Hook-名稱" class="headerlink" title="註冊排程 Hook 名稱"></a>註冊排程 Hook 名稱</h3><p>有別於其他功能的 Hook，我們要把排程 Hook 寫在外掛的主程式裡面：</p>
<p><strong>ods-wc-order-export.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * Plugin Name:       ODS WooCommerce Order Export
 * Plugin URI:        https://oberonlai.blog
 * Description:       WooCommerce 客製化報表自動匯出&amp;上傳功能
 * Version:           1.0.1
 * Author:            Oberon Lai
 * Author URI:        https://oberonlai.blog
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token operator">...</span>

<span class="token comment">// 加入排程 Hook</span>
<span class="token keyword">function</span> <span class="token function">sp_activation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">wp_next_scheduled</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ods_wc_order_export_cron'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">wp_schedule_event</span><span class="token punctuation">(</span> <span class="token function">strtotime</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'00:00:00'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'daily'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ods_wc_order_export_cron'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">register_activation_hook</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_activation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">sp_deactivation</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token function">wp_clear_scheduled_hook</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ods_wc_order_export_cron'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">register_deactivation_hook</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_deactivation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

ods_wc_order_export_cron 為 Hook 名稱，稍後需要執行的任務會掛在這個 Hook 上，wp_schedule_event 為註冊排程 Hook 的 <span class="token keyword">function</span>，第一個參數 timestamp，使用 strtotime 為 <span class="token constant">UTF</span><span class="token operator">-</span><span class="token number">0</span>，所以如果想在台灣時間下午一點執行的話，就要寫 <span class="token number">13</span><span class="token operator">-</span><span class="token number">8</span> <span class="token operator">=</span> <span class="token number">5</span><span class="token punctuation">:</span><span class="token number">00</span><span class="token punctuation">:</span><span class="token number">00</span>。

第二個參數 daily 設定執行頻率為每天，最後則是 Hook 名稱。使用 register_activation_hook 讓外掛啟用時註冊這個排程 Hook，而用 register_deactivation_hook 在外掛停用時取消這個排程，這樣可以減少主機的壓力，沒用到的東西就把它移除掉。

接下來與前面的步驟一樣，我們先把 Hook 處理好再來寫實作細節，開啟 <span class="token keyword">class</span><span class="token operator">-</span>ods<span class="token operator">-</span>hook<span class="token operator">.</span>php 來加入排程：</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>ods-wc-order-export/class/class-ods-hook.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.引入 class
 * 2.訂單新增系統傳送狀態欄位，用來紀錄該訂單是否已被傳送至企業內部系統
 * 3.處理 Hooks
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-helper.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-wc-admin.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-wc-order.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-csv.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-ftp.php'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_Hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_Hook</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$plugin_version</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$wc_admin</span><span class="token punctuation">,</span> <span class="token variable">$csv</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token operator">...</span>

      <span class="token comment">// 訂單自動匯出 csv</span>
      <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ods_wc_order_export_cron'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token variable">$csv</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'set_transfer_delivered'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token variable">$erp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_Hook</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_WC_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_CSV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>這邊還有一個 Hook 要補上：因為自動處理的訂單需要篩選出系統傳送狀態為未傳送的訂單，而使用 WC_Order_Query 要篩選自訂欄位必須要另外增加 Hook 來處理，所以再加上下面這段 Hook：</p>
<p><strong>ods-wc-order-export/class/class-ods-hook.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.引入 class
 * 2.訂單新增系統傳送狀態欄位，用來紀錄該訂單是否已被傳送至企業內部系統
 * 3.處理 Hooks
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-helper.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-wc-admin.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-wc-order.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-csv.php'</span><span class="token punctuation">;</span>
<span class="token keyword">require</span> <span class="token function">plugin_dir_path</span><span class="token punctuation">(</span> <span class="token constant">__FILE__</span> <span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'class-ods-ftp.php'</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_Hook'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  
  <span class="token keyword">class</span> <span class="token class-name">ODS_Hook</span> <span class="token punctuation">&#123;</span>
    
    <span class="token keyword">private</span> <span class="token variable">$plugin_version</span><span class="token punctuation">;</span>

    <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span> <span class="token variable">$wc_admin</span><span class="token punctuation">,</span> <span class="token variable">$csv</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>

      <span class="token operator">...</span>

      <span class="token comment">// 把系統傳送狀態加入 wc order query 的搜尋條件</span>
      <span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'woocommerce_order_data_store_cpt_get_orders_query'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ODS_WC_Order::set_order_query_custom_key'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
  
  <span class="token variable">$erp</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ODS_Hook</span><span class="token punctuation">(</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_WC_Admin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token class-name">ODS_CSV</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>set_order_query_custom_key 因為是跟 WooCommerce 訂單相關的事件，所以定義在 class-ods-wc-order.php 裡面</p>
<p><strong>ods-wc-order-export</strong>/<strong>class/class-ods-wc-order.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 取得訂單資訊
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_WC_Order'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_WC_Order</span> <span class="token punctuation">&#123;</span>

<span class="token operator">...</span>

<span class="token comment">/**
     * 加入 order query 搜尋條件系統傳送狀態
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">set_order_query_custom_key</span><span class="token punctuation">(</span> <span class="token variable">$query</span><span class="token punctuation">,</span> <span class="token variable">$query_vars</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$query_vars</span>\<span class="token punctuation">[</span><span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token variable">$query</span>\<span class="token punctuation">[</span><span class="token string single-quoted-string">'meta_query'</span>\<span class="token punctuation">]</span>\<span class="token punctuation">[</span>\<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
          <span class="token string single-quoted-string">'key'</span> <span class="token operator">=></span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span><span class="token punctuation">,</span>
          <span class="token string single-quoted-string">'value'</span> <span class="token operator">=></span> <span class="token function">esc_attr</span><span class="token punctuation">(</span> <span class="token variable">$query_vars</span>\<span class="token punctuation">[</span><span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
      <span class="token keyword">return</span> <span class="token variable">$query</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下來去 class-ods-csv.php 實作 set_send_transfer_delivered 的細節：</p>
<p><strong><strong>ods-wc-order-export</strong></strong>/<strong>class/class-ods-csv.php</strong></p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">/**
 * 1.設定批次操作要執行的動作
 * 2.組合CSV欄位
 * 3.執行FTP上傳
 */</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">defined</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'ABSPATH'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token keyword">exit</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">class_exists</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ODS_CSV'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
  <span class="token keyword">class</span> <span class="token class-name">ODS_CSV</span> <span class="token punctuation">&#123;</span>

    <span class="token operator">...</span>

    <span class="token comment">/**
     * 每日自動處理配系統傳送狀態改為已傳送
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">set_send_transfer_delivered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
      <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WC_Order_Query</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string single-quoted-string">'limit'</span> <span class="token operator">=></span> <span class="token number">9999</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'return'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'ids'</span><span class="token punctuation">,</span>
        <span class="token constant">ODS_WC_ORDER_EXPORT_META_KEY</span> <span class="token operator">=></span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">0</span>\<span class="token punctuation">]</span>
      <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token variable">$orders</span> <span class="token operator">=</span> <span class="token variable">$query</span><span class="token operator">-></span><span class="token function">get_orders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$orders</span> <span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token variable">$orders</span> <span class="token keyword">as</span> <span class="token variable">$order_id</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">set_send_transfer</span><span class="token punctuation">(</span> <span class="token variable">$order_id</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">0</span>\<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">1</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">update_send_status</span><span class="token punctuation">(</span> <span class="token variable">$order_id</span><span class="token punctuation">,</span> <span class="token constant">ODS_WC_ORDER_EXPORT_META_VALUE</span>\<span class="token punctuation">[</span><span class="token number">1</span>\<span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>

  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在第 25 行的地方就是我們剛剛使用 set_order_query_custom_key 加入的功能，篩選出系統傳送狀態為未傳送的訂單，然後直接呼叫 set_send_transfer 來匯出 csv 檔即可。</p>
<p>做 WP Cron 需要注意的地方是只有當網站有訪客瀏覽時才會進行觸發，如果是三更半夜或是頁面有快取的話，很可能就不會被觸發到，最保險的方法還是用系統的 crontab 來執行 wp-cron.php，或是 wget 來進行呼叫。</p>
<p>註冊好排程之後，可以用 <a target="_blank" rel="noopener" href="https://wordpress.org/plugins/wp-crontrol/">WP Crontrol</a> 這隻外掛來檢視目前站內已經有排定的 Cron，然後用 <a target="_blank" rel="noopener" href="https://wordpress.org/plugins/cron-logger/">Cron Log</a> 來追蹤已經執行過的排程，用這兩隻外掛就能很方便管理 WP Cron。</p>
<h2 id="總結"><a href="#總結" class="headerlink" title="總結"></a>總結</h2><p>以上完整的程式碼可以參考我的 Github —&gt; <a target="_blank" rel="noopener" href="https://github.com/oberonlai/ods-wc-order-export">https://github.com/oberonlai/ods-wc-order-export</a>，如果在實務上需要加入更多報表的運算或處理，像是計算折扣商品、變化商品甚至是組合商品等等，都可以用這隻外掛下去做衍伸修改，希望能幫助到有需要的朋友！</p>
<h3 id="參考資料"><a href="#參考資料" class="headerlink" title="參考資料"></a>參考資料</h3><p>感謝下面各位大大的指導與分享：</p>
<p><a target="_blank" rel="noopener" href="https://www.itread01.com/content/1544468049.html">PHP使用FTP上傳檔案到伺服器(實戰篇)</a><br><a target="_blank" rel="noopener" href="https://www.mxp.tw/6852/">[PHP] 寫出一個匯出 CSV 檔案的起手式</a><br><a target="_blank" rel="noopener" href="https://code.yidas.com/php-csv-excel-output/">[PHP] 匯出處理 – CSV、EXCEL匯出實例教學</a><br><a target="_blank" rel="noopener" href="https://www.webhat.in/article/woocommerce-tutorial/how-to-get-order-details-by-order-id/">How to Get Order Details by Order ID</a><br><a target="_blank" rel="noopener" href="https://make.wordpress.org/core/2016/10/04/custom-bulk-actions/">Using Custom Bulk Actions</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/24723182/how-to-sort-orders-based-on-orders-meta-value-in-woocommerce-wordpress">How to sort orders based on orders meta value in Woocommerce / Wordpress</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/53346544/add-custom-order-status-to-filter-menu-in-woocommerce-admin-orders-list">Add custom order status to filter menu in WooCommerce Admin Orders list</a><br><a target="_blank" rel="noopener" href="https://github.com/woocommerce/woocommerce/wiki/wc_get_orders-and-WC_Order_Query#description">wc_get_orders and WC_Order_Query</a><br><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/56132215/filter-orders-by-product-post-type-in-woocommerce-admin-orders-list-page">Filter orders by product post type in WooCommerce admin orders list page</a></p>

    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tw/tags/wp-cron/" rel="tag"><i class="fa fa-tag"></i> wp-cron</a>
              <a href="/tw/tags/csv/" rel="tag"><i class="fa fa-tag"></i> csv</a>
              <a href="/tw/tags/ftp/" rel="tag"><i class="fa fa-tag"></i> ftp</a>
              <a href="/tw/tags/WooCoomerce%E8%A8%82%E5%96%AE/" rel="tag"><i class="fa fa-tag"></i> WooCoomerce訂單</a>
              <a href="/tw/tags/%E5%A0%B1%E8%A1%A8%E5%8C%AF%E5%87%BA/" rel="tag"><i class="fa fa-tag"></i> 報表匯出</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/tw/building-web-apps-with-wordpress-api-objects-and-helper-functions/" rel="prev" title="【 書摘 】Building Web Apps with WordPress - 使用 WordPress API、物件、與實用函式">
      <i class="fa fa-chevron-left"></i> 【 書摘 】Building Web Apps with WordPress - 使用 WordPress API、物件、與實用函式
    </a></div>
      <div class="post-nav-item">
    <a href="/tw/how-to-write-the-effective-specification/" rel="next" title="【 心得 】企劃人員如何撰寫有效的軟體需求規格文件">
      【 心得 】企劃人員如何撰寫有效的軟體需求規格文件 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E5%88%86%E6%9E%90"><span class="nav-number">1.</span> <span class="nav-text">需求分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%BB%E5%8B%99%E6%8B%86%E8%A7%A3"><span class="nav-number">2.</span> <span class="nav-text">任務拆解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Let%E2%80%99s-Party-Start"><span class="nav-number">3.</span> <span class="nav-text">Let’s Party Start!</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WooCommerce-%E5%BE%8C%E5%8F%B0%E8%A8%82%E5%96%AE%E4%BB%8B%E9%9D%A2"><span class="nav-number">4.</span> <span class="nav-text">WooCommerce 後台訂單介面</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E3%80%81%E8%A8%82%E5%96%AE%E5%88%97%E8%A1%A8%E9%A0%81%E7%9A%84%E8%A1%A8%E6%A0%BC%E5%A2%9E%E5%8A%A0%E7%B3%BB%E7%B5%B1%E5%82%B3%E9%80%81%E7%8B%80%E6%85%8B%E7%9A%84%E6%AC%84%E4%BD%8D"><span class="nav-number">4.1.</span> <span class="nav-text">一、訂單列表頁的表格增加系統傳送狀態的欄位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BA%8C%E3%80%81%E5%8A%A0%E5%85%A5%E7%AF%A9%E9%81%B8%E5%8A%9F%E8%83%BD%EF%BC%8C%E5%8F%AF%E4%BB%A5%E4%BD%BF%E7%94%A8%E7%B3%BB%E7%B5%B1%E5%82%B3%E9%80%81%E7%8B%80%E6%85%8B%E4%BE%86%E7%AF%A9%E9%81%B8%E8%A8%82%E5%96%AE"><span class="nav-number">4.2.</span> <span class="nav-text">二、加入篩選功能，可以使用系統傳送狀態來篩選訂單</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%89%E3%80%81%E5%8B%BE%E9%81%B8%E8%A8%82%E5%96%AE%E5%BE%8C%E7%9A%84%E6%89%B9%E6%AC%A1%E6%93%8D%E4%BD%9C%E8%99%95%E7%90%86"><span class="nav-number">4.3.</span> <span class="nav-text">三、勾選訂單後的批次操作處理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WooCommerce-%E8%A8%82%E5%96%AE%E8%B3%87%E6%96%99%E5%8F%96%E5%BE%97"><span class="nav-number">5.</span> <span class="nav-text">WooCommerce 訂單資料取得</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8C%AF%E5%87%BA-csv-%E6%AA%94%E8%88%87-FTP-%E4%B8%8A%E5%82%B3"><span class="nav-number">6.</span> <span class="nav-text">匯出 csv 檔與 FTP 上傳</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%95%B4%E7%90%86-csv-%E6%AC%84%E4%BD%8D"><span class="nav-number">6.1.</span> <span class="nav-text">整理 csv 欄位</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E7%B5%A6%E6%89%B9%E6%AC%A1%E6%93%8D%E4%BD%9C%E5%B0%8D%E6%87%89%E5%8B%95%E4%BD%9C"><span class="nav-number">6.2.</span> <span class="nav-text">指定給批次操作對應動作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#FTP-%E4%B8%8A%E5%82%B3"><span class="nav-number">6.3.</span> <span class="nav-text">FTP 上傳</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%92%E7%A8%8B%E8%A8%AD%E5%AE%9A"><span class="nav-number">7.</span> <span class="nav-text">排程設定</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%BB%E5%86%8A%E6%8E%92%E7%A8%8B-Hook-%E5%90%8D%E7%A8%B1"><span class="nav-number">7.1.</span> <span class="nav-text">註冊排程 Hook 名稱</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%B8%BD%E7%B5%90"><span class="nav-number">8.</span> <span class="nav-text">總結</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%83%E8%80%83%E8%B3%87%E6%96%99"><span class="nav-number">8.1.</span> <span class="nav-text">參考資料</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="賴俊吾 / Oberon Lai"
      src="/tw/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">賴俊吾 / Oberon Lai</p>
  <div class="site-description" itemprop="description">現為全職 WordPress 工程師，網站開發經歷 11 年，專攻前端工程與 WordPress 佈景主題、外掛客製化開發</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/tw/archives">
          <span class="site-state-item-count">252</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/tw/categories/">
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tw/tags/">
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/oberonlai" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oberonlai" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:m615926@gmail.com" title="E-Mail → mailto:m615926@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/oberonlai" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;oberonlai" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/m615926" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;m615926" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">賴俊吾 / Oberon Lai</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="總字數">563k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">8:31</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/tw/lib/anime.min.js"></script>
  <script src="/tw/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>

<script src="/tw/js/utils.js"></script>


<script src="/tw/js/schemes/muse.js"></script>


<script src="/tw/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/tw/js/local-search.js"></script>













    <div id="pjax">
  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://oberon-lai.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://oberonlai.blog/tw/woocommerce-order-export/";
    this.page.identifier = "woocommerce-order-export/";
    this.page.title = "【 筆記 】WooCommerce 客製化報表自動匯出&上傳功能開發";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://oberon-lai.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

    </div>
</body>
</html>
