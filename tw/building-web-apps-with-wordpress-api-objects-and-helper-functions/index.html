<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/tw/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/tw/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/tw/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/tw/images/logo.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/tw/css/main.css">


<link rel="stylesheet" href="/tw/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"oberonlai.blog","root":"/tw/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":true,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":"disqus","storage":true,"lazyload":false,"nav":{"disqus":{"text":"Load Disqus","order":-1}},"activeClass":"disqus"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideDownIn","sidebar":"slideDownIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="Shortcode APIShortcode 是在後台編輯器中用來產生動態內容的一段短代碼，它有三種形式：    直接顯示內容，像是 [myshortcode]   帶有屬性，像是 [myshortcode id&#x3D;”1” type&#x3D;”text”]   像 HTML 一樣有前後標籤包內文包住，像是 [myshortcode id&#x3D;”1”] 這邊是文字內容…[&#x2F;myshortcode]   Short">
<meta property="og:type" content="article">
<meta property="og:title" content="【 書摘 】Building Web Apps with WordPress - 使用 WordPress API、物件、與實用函式">
<meta property="og:url" content="https://oberonlai.blog/tw/building-web-apps-with-wordpress-api-objects-and-helper-functions/">
<meta property="og:site_name" content="WordPress 開發日常">
<meta property="og:description" content="Shortcode APIShortcode 是在後台編輯器中用來產生動態內容的一段短代碼，它有三種形式：    直接顯示內容，像是 [myshortcode]   帶有屬性，像是 [myshortcode id&#x3D;”1” type&#x3D;”text”]   像 HTML 一樣有前後標籤包內文包住，像是 [myshortcode id&#x3D;”1”] 這邊是文字內容…[&#x2F;myshortcode]   Short">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-18-at-09.40.44-1024x372.jpg">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-27-at-09.08.42.jpg">
<meta property="og:image" content="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-27-at-09.29.38.jpg">
<meta property="article:published_time" content="2020-05-11T00:48:26.000Z">
<meta property="article:modified_time" content="2021-05-01T12:46:03.708Z">
<meta property="article:author" content="賴俊吾 &#x2F; Oberon Lai">
<meta property="article:tag" content="crontab">
<meta property="article:tag" content="dashborard">
<meta property="article:tag" content="file header api">
<meta property="article:tag" content="heartbeat api">
<meta property="article:tag" content="rewrite rule">
<meta property="article:tag" content="shortcode">
<meta property="article:tag" content="wget">
<meta property="article:tag" content="widget">
<meta property="article:tag" content="wp_mail">
<meta property="article:tag" content="wp-cron">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-18-at-09.40.44-1024x372.jpg">

<link rel="canonical" href="https://oberonlai.blog/tw/building-web-apps-with-wordpress-api-objects-and-helper-functions/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>【 書摘 】Building Web Apps with WordPress - 使用 WordPress API、物件、與實用函式 | WordPress 開發日常</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-163107142-1"></script>
    <script data-pjax>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-163107142-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta custom-logo">

    <a href="/tw/" class="brand" rel="start" style="display: block">
        <img class="logo-img" src="/tw/images/logo-w.svg" alt="WordPress 開發日常">
    </a>
      <p class="site-subtitle" itemprop="description">有任何 WordPress 客製需求歡迎與我聯絡！</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-關於我">

    <a href="/tw/about/" rel="section">關於我</a>

  </li>
        <li class="menu-item menu-item-合作方式">

    <a href="/tw/how-can-oberon-help-you/" rel="section">合作方式</a>

  </li>
        <li class="menu-item menu-item-計價方式">

    <a href="/tw/how-do-i-make-a-quotation/" rel="section">計價方式</a>

  </li>
        <li class="menu-item menu-item-學習-wordpress">

    <a href="/tw/wordpress-full-stack/" rel="section">學習 WordPress</a>

  </li>
        <li class="menu-item menu-item-與我聯繫">

    <a href="mailto:m615926@gmail.com" rel="noopener" target="_blank">與我聯繫</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger">搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/oberonlai" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://oberonlai.blog/tw/building-web-apps-with-wordpress-api-objects-and-helper-functions/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/tw/images/avatar.jpg">
      <meta itemprop="name" content="賴俊吾 / Oberon Lai">
      <meta itemprop="description" content="現為全職 WordPress 工程師，網站開發經歷 11 年，專攻前端工程與 WordPress 佈景主題、外掛客製化開發">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="WordPress 開發日常">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          【 書摘 】Building Web Apps with WordPress - 使用 WordPress API、物件、與實用函式
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2020-05-11 08:48:26" itemprop="dateCreated datePublished" datetime="2020-05-11T08:48:26+08:00">2020-05-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2021-05-01 20:46:03" itemprop="dateModified" datetime="2021-05-01T20:46:03+08:00">2021-05-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/tw/categories/WordPress/" itemprop="url" rel="index"><span itemprop="name">WordPress</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/tw/categories/WordPress/WordPress-Plugins/" itemprop="url" rel="index"><span itemprop="name">WordPress Plugins</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus：</span>
    
    <a title="disqus" href="/tw/building-web-apps-with-wordpress-api-objects-and-helper-functions/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="building-web-apps-with-wordpress-api-objects-and-helper-functions/" itemprop="commentCount"></span>
    </a>
  </span>
  
  
            <span class="post-meta-item" title="文章字數">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="所需閱讀時間">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>27 分鐘</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="Shortcode-API"><a href="#Shortcode-API" class="headerlink" title="Shortcode API"></a>Shortcode API</h2><p>Shortcode 是在後台編輯器中用來產生動態內容的一段短代碼，它有三種形式：</p>
<ul>
<li>  直接顯示內容，像是 [myshortcode]</li>
<li>  帶有屬性，像是 [myshortcode id=”1” type=”text”]</li>
<li>  像 HTML 一樣有前後標籤包內文包住，像是 [myshortcode id=”1”] 這邊是文字內容…[/myshortcode]</li>
</ul>
<blockquote>
<p>Shortcode 的使用場景我通常是用來提供給不熟悉 HTML 與 CSS 的客戶，在上文章內容的時候可以使用我們幫他設計好的 UI 元件，我將 UI 元件的 HTML 包裝成 shortcode，所以只要打 [title text=”標題文字”]，就會出現 h2 並帶有特定 class 的標題文字。</p>
</blockquote>
<p>建立 Shortcode 的第一個步驟，先使用 add_shortcode() 來定義 callback function，需要使用在 Shortcode 裡面的屬性要以陣列的格式傳入 callback function 的第一個參數，第二個參數為要被 Shortcode 包住的內容，下面範例說明如何新增一個帶有屬性以及內容的 Shortcode：</p>
<span id="more"></span>

<pre class="line-numbers language-php" data-language="php"><code class="language-php">
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
  shortcode callback for [msg] shortcode
  Example: [msg type="error"]This is an error message.[/msg]
  Output:
  &lt;div class="message message-error">
      &lt;p>This is an error message.&lt;/p>
  &lt;/div>
*/</span>
<span class="token keyword">function</span> <span class="token function">sp_msg_shortcode</span><span class="token punctuation">(</span><span class="token variable">$atts</span><span class="token punctuation">,</span> <span class="token variable">$content</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// 屬性的預設值</span>
  <span class="token function">extract</span><span class="token punctuation">(</span> <span class="token function">shortcode_atts</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
        <span class="token string single-quoted-string">'type'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'information'</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token variable">$atts</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">do_shortcode</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//allow nested shortcodes</span>
  <span class="token variable">$r</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;div class="message message-'</span> <span class="token operator">.</span>
    <span class="token variable">$type</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'">&lt;p>'</span> <span class="token operator">.</span> <span class="token variable">$content</span> <span class="token operator">.</span> <span class="token string single-quoted-string">'&lt;/p>&lt;/div>'</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token variable">$r</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_shortcode</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'msg'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_msg_shortcode'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// msg 為 Shortcode 名稱</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>在 callback 裡面要返回值使用 return 優於 echo，因為 Shortcode filter 會在還沒有任何內容產生前執行，如果是用 echo 的話，輸出的結果會跑到頁面最上方而非在你想要的位置。</p>
<h3 id="Shortcode-屬性"><a href="#Shortcode-屬性" class="headerlink" title="Shortcode 屬性"></a>Shortcode 屬性</h3><p>上面範例中使用 shortcode_atts() 來處理要帶入的屬性，它有三個參數傳入方式：$pairs、$atts 與 $shortcode。$pairs 是屬性預設值的陣列，使用 key / value 的方式來指定屬性名與預設值，範例中只有一個屬性，而預設值為 information。</p>
<p>而 $atts 則是定義屬性的陣列，shortcode_atts() 會把 $pairs 跟 $atts 合併為一個陣列，所以這兩個參數為必填。第三個參數 $shortcode 為選填，如果設定該 shortcode 名稱 ( 範例為 msg )，那麼 filter shortcode_atts_msg 就會被觸發，這樣其他的外掛就可以用這支 filter 去取代該 shortcode 的屬性預設值。</p>
<p>shortcode_atts() 的結果再使用 PHP 的 extract() 來處理，它可以自動把陣列中的 key 直接轉換成變數，之後就能用在 $content 裡面，因此 echo $type 會輸出 information。</p>
<h3 id="巢狀-Shortocde"><a href="#巢狀-Shortocde" class="headerlink" title="巢狀 Shortocde"></a>巢狀 Shortocde</h3><p>範例中的 $content = do_shortcode($content) 讓你可以在 Shortcode 裡面再放入另外一組 Shortcode，譬如有另外一個 Shortcode 叫做 [help_link]，則可以這樣寫：</p>
<p>[msg type=”error”] 這裡放一些文字 [help_link] 這裡是連結 [/msg]</p>
<p>需要注意的是如果是把相同名稱的 Shortcode 放進裡面會爆炸，因為 WordPress 是用正規表示法來解析 Shortcode 的內容，它會把 Shortcode 裡面的資料做解析，如果是自己包自己，會大幅影響解析的速度進而產生問題，因此比較好的作法是不要用巢狀 Shortcode，或是使用別的 Shortcode 名稱來指定同一個 callback function，不然就是要自己寫正規法來判斷。</p>
<p>do_shortcode 還可以拿來顯示自訂欄位、自訂資料表的資料或是其他還沒有被 the_content filter 所執行的內容。通常情況下，會用 apply_filters( “the_content” , $content ) 來做比較適合，它會執行所有在 the_content filter 上的 hook，當然也包含 Shortcode 的 filter。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">global</span> <span class="token variable">$post</span><span class="token punctuation">;</span>
<span class="token variable">$sidebar_content</span> <span class="token operator">=</span> <span class="token variable">$post</span><span class="token operator">-></span><span class="token property">sidebar_content</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">the_content</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sidebar<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
  <span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
    <span class="token comment">//echo do_shortcode($sidebar_content);</span>
    <span class="token keyword">echo</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'the_content'</span><span class="token punctuation">,</span> <span class="token variable">$sidebar_content</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 通常用這個</span>
  <span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>do_shortcode() 最常用到的地方就是當需要把 Shortocde 寫在 php 裡面的時候。依照作者的範例，如果要在 php 顯示 msg 這個 Shortcode 可以這樣寫：<?php echo do_shortcode("[msg type='error']這裡是一些文字[/msg]"); ?></p>
<p>至於何時該用 apply_filters 還是 do_shortcode 來顯示 Shortcode，<a target="_blank" rel="noopener" href="https://wordpress.stackexchange.com/questions/173844/apply-filtersthe-content-content-vs-do-shortcodecontent">這一篇</a>有很好的解釋，簡單說看你是要單純顯示 Shortcode 就好，還是要把除了 Shortcode 以及其他掛在 the_content 的 filter 都顯示出來，需要後者的話就使用 apply_filters( ‘the_content’, $content) 吧～</p>
</blockquote>
<h3 id="移除-Shortcode"><a href="#移除-Shortcode" class="headerlink" title="移除 Shortcode"></a>移除 Shortcode</h3><p>使用 remove_shortcode() 移除單一已註冊的 Shortcode，使用 remove_all_shortcodes() 移除所有 Shortcode。在執行 remove_shortcode() 的時候，要確保它是放在已註冊 Shortcode 完成後才執行，不然會抓不到，使用 hook 的 priority 參數來進行設定。</p>
<p>已註冊的 Shortcode 會被放在全域變數 $shortcode_tags 裡面，可以直接操作這個變數來改變 Shortcode 狀態。譬如說，如果你想要讓某些內容不能停用某些 Shortcode，可以先把 $shortcode_tags 裡面的值做備份，然後判斷在特定頁面下存新的值進去，範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> 
<span class="token comment">// 製作 Shortcode 備份</span>
<span class="token keyword">global</span> <span class="token variable">$shortcode_tags</span><span class="token punctuation">;</span>
<span class="token variable">$original_shortcode_tags</span> <span class="token operator">=</span> <span class="token variable">$shortcode_tags</span><span class="token punctuation">;</span>

<span class="token comment">// 移除 Shortcode msg </span>
<span class="token keyword">unset</span><span class="token punctuation">(</span><span class="token variable">$shortcode_tags</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'msg'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 輸出內容，這時候 msg 是無法使用的</span>
<span class="token variable">$content</span> <span class="token operator">=</span> <span class="token function">do_shortcode</span><span class="token punctuation">(</span><span class="token variable">$content</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">echo</span> <span class="token variable">$content</span><span class="token punctuation">;</span>

<span class="token comment">// 還原所有 Shortcode</span>
<span class="token variable">$shortcode_tags</span> <span class="token operator">=</span> <span class="token variable">$original_shortcode_tags</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="其他實用的-Shortcode-Function"><a href="#其他實用的-Shortcode-Function" class="headerlink" title="其他實用的 Shortcode Function"></a>其他實用的 Shortcode Function</h3><p><strong>shortcode_exists( $tag )</strong><br>判斷特定 Shortcode 有沒有被註冊</p>
<p><strong>has_shortcode( $content, $tag )</strong><br>判斷特定 Shortcode 有沒有在 $content 裡面被使用</p>
<p><strong>shortcode_parse_atts( $text )</strong><br>當要取得 Shortcode 的屬性時，可以把整段 Shortcode 帶入這支 function 的參數，就可以得到 key/value 形式的 Shortcode 屬性陣列，範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$atts</span> <span class="token operator">=</span> <span class="token function">shortcode_parse_atts</span><span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'[soundcloud url="http://api.soundcloud.com/tracks/67658191" params="" width=" 100%" height="166" iframe="true" /]'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token variable">$atts</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'url'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// 輸出 http://api.soundcloud.com/tracks/67658191</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>strip_shortcodes( $content )</strong><br>把內文裡面的 Shortcode 全部移除</p>
<h2 id="Widget-API"><a href="#Widget-API" class="headerlink" title="Widget API"></a>Widget API</h2><p>Widget 就是在後台 &gt; 外觀 &gt; 小工具 裡面的元件，但在開發 Widget 前，可以仔細思考一下是否真的需要另外開發它，因為 WordPress 本身已經有許多內建的 Widget，研究一下它們，也許你的需求都能透過它們來解決。</p>
<h3 id="新增-Widget"><a href="#新增-Widget" class="headerlink" title="新增 Widget"></a>新增 Widget</h3><p>要新增 Widget 你必須要繼承一支 class 叫做 WP_Widget，它被定義在 wp-includes/widgets.php 裡面，有四個 methods 需要被覆寫，程式碼如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
  Taken from the Widgets API Codex Page at:
  http://codex.wordpress.org/Widgets_API
*/</span>
<span class="token keyword">class</span> <span class="token class-name">My_Widget</span> <span class="token keyword">extends</span> <span class="token class-name">WP_Widget</span> <span class="token punctuation">&#123;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// widget actual processes</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">widget</span><span class="token punctuation">(</span> <span class="token variable">$args</span><span class="token punctuation">,</span> <span class="token variable">$instance</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// outputs the content of the widget</span>
<span class="token punctuation">&#125;</span>

 <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span> <span class="token variable">$instance</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// outputs the options form on admin</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span> <span class="token variable">$new_instance</span><span class="token punctuation">,</span> <span class="token variable">$old_instance</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">// processes widget options to be saved</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'widgets_init'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
     <span class="token function">register_widget</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'My_Widget'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>add_action 第二個參數可以帶匿名函式是 PHP 5.3 之後才有支援，而 WordPress 最低安裝需求為 PHP 5.2.4。另一個方法是用 create_function，可以相容較舊的 PHP 版本。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
  Taken from the Widgets API Codex Page at:
  http://codex.wordpress.org/Widgets_API
*/</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'widgets_init'</span><span class="token punctuation">,</span>
     <span class="token function">create_function</span><span class="token punctuation">(</span><span class="token string single-quoted-string">''</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'return register_widget("My_Widget");'</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>作者外掛 SchoolPress 使用 Widget 來顯示所有班級或是指定班級 ( BuddyPress 的 Group )中的筆記，可以讓社團管理者 ( 老師 ) 自行設定：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
  Widget to show the current class note.
  Teachers (Group Admins) can change note for each group.
  Shows the global note set in the widget settings if non-empty.
*/</span>
<span class="token keyword">class</span> <span class="token class-name">SchoolPress_Note_Widget</span> <span class="token keyword">extends</span> <span class="token class-name">WP_Widget</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token keyword static-context">parent</span><span class="token operator">::</span><span class="token function">__construct</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'schoolpress_note'</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'SchoolPress Note'</span><span class="token punctuation">,</span>
<span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'description'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'Note to Show on Group Pages'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">widget</span><span class="token punctuation">(</span> <span class="token variable">$args</span><span class="token punctuation">,</span> <span class="token variable">$instance</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">global</span> <span class="token variable">$current_user</span><span class="token punctuation">;</span>

<span class="token comment">//saving a note edit?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'schoolpress_note_text'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>
<span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'class_id'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token comment">//make sure this is an admin</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">groups_is_user_admin</span><span class="token punctuation">(</span><span class="token variable">$current_user</span><span class="token operator">-></span><span class="token constant">ID</span><span class="token punctuation">,</span><span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'class_id'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token comment">//should escape the text and possibly use a nonce</span>
<span class="token function">update_option</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'schoolpress_note_'</span> <span class="token operator">.</span> <span class="token function">intval</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'class_id'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'schoolpress_note_text'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//look for a global note</span>
<span class="token variable">$note</span> <span class="token operator">=</span> <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'note'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token comment">//get class id for this group</span>
<span class="token variable">$class_id</span> <span class="token operator">=</span> <span class="token function">bp_get_current_group_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//look for a class note</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$note</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$class_id</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$note</span> <span class="token operator">=</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"schoolpress_note_"</span> <span class="token operator">.</span> <span class="token variable">$class_id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//display note</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$note</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schoolpress_note<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">wpautop</span><span class="token punctuation">(</span> <span class="token variable">$note</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>

<span class="token comment">//show edit for group admins</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">groups_is_user_admin</span><span class="token punctuation">(</span> <span class="token variable">$current_user</span><span class="token operator">-></span><span class="token constant">ID</span><span class="token punctuation">,</span> <span class="token variable">$class_id</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schoolpress_note_edit_trigger<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>Edit<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schoolpress_note_edit<span class="token punctuation">"</span></span> <span class="token style-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token style language-css"><span class="token property">display</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>form</span> <span class="token attr-name">action</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name">method</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>post<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span>
<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>class_id<span class="token punctuation">"</span></span>
<span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">intval</span><span class="token punctuation">(</span><span class="token variable">$class_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schoolpress_note_text<span class="token punctuation">"</span></span> <span class="token attr-name">cols</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>30<span class="token punctuation">"</span></span> <span class="token attr-name">rows</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>5<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">esc_textarea</span><span class="token punctuation">(</span><span class="token function">get_option</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'schoolpress_note_'</span><span class="token operator">.</span><span class="token variable">$class_id</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>submit<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>Save<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>schoolpress_note_edit_cancel<span class="token punctuation">"</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>javascript:void(0);<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
Cancel
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>form</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token function">jQuery</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span><span class="token string">'#schoolpress_note_edit_trigger'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span><span class="token string">'#schoolpress_note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span><span class="token string">'#schoolpress_note_edit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span><span class="token string">'#schoolpress_note_edit_cancel'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span><span class="token string">'#schoolpress_note'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">show</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span><span class="token string">'#schoolpress_note_edit'</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">form</span><span class="token punctuation">(</span> <span class="token variable">$instance</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'note'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span>
<span class="token variable">$note</span> <span class="token operator">=</span> <span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'note'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">else</span>
<span class="token variable">$note</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span> <span class="token attr-name">for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">get_field_id</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'note'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">_e</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Note:'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>textarea</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">get_field_id</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'note'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span>
<span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$this</span><span class="token operator">-></span><span class="token function">get_field_name</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'note'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">esc_textarea</span><span class="token punctuation">(</span> <span class="token variable">$note</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>textarea</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">update</span><span class="token punctuation">(</span> <span class="token variable">$new_instance</span><span class="token punctuation">,</span> <span class="token variable">$old_instance</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$instance</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token variable">$instance</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'note'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$new_instance</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'note'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token keyword">return</span> <span class="token variable">$instance</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'widgets_init'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">register_widget</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'SchoolPress_Note_Widget'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="定義-Widget-區塊"><a href="#定義-Widget-區塊" class="headerlink" title="定義 Widget 區塊"></a>定義 Widget 區塊</h3><p>要讓你的 Theme 可以支援顯示 Widget 要做兩件事：第一個先要註冊 Widget 區塊，然後才能讓它顯示在前端頁面。要註冊 Widget 區塊使用 register_sidebar( $args )，只能接收一個陣列參數，參數內容說明如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
 * Add a sidebar.
 */</span>
<span class="token keyword">function</span> <span class="token function">wpdocs_theme_slug_widgets_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
  <span class="token function">register_sidebar</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
    <span class="token string single-quoted-string">'name'</span>          <span class="token operator">=></span> <span class="token function">__</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Main Sidebar'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'textdomain'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// 區塊名稱，重複名字會+1</span>
    <span class="token string single-quoted-string">'id'</span>               <span class="token operator">=></span> <span class="token string single-quoted-string">'sidebar-1'</span><span class="token punctuation">,</span>                           <span class="token comment">// 區塊 ID</span>
    <span class="token string single-quoted-string">'description'</span>   <span class="token operator">=></span> <span class="token function">__</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'Description'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'textdomain'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// 區塊說明</span>
    <span class="token string single-quoted-string">'before_widget'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'&lt;li id="%1$s" class="widget %2$s">'</span><span class="token punctuation">,</span>  <span class="token comment">// 包住區塊的開頭 HTML</span>
    <span class="token string single-quoted-string">'after_widget'</span>  <span class="token operator">=></span> <span class="token string single-quoted-string">'&lt;/li>'</span><span class="token punctuation">,</span>                               <span class="token comment">// 包住區塊的結尾 HTML</span>
    <span class="token string single-quoted-string">'before_title'</span>  <span class="token operator">=></span> <span class="token string single-quoted-string">'&lt;h2 class="widgettitle">'</span><span class="token punctuation">,</span>            <span class="token comment">// 包住區塊標題的開頭 HTML</span>
    <span class="token string single-quoted-string">'after_title'</span>   <span class="token operator">=></span> <span class="token string single-quoted-string">'&lt;/h2>'</span><span class="token punctuation">,</span>                               <span class="token comment">// 包住區塊標題的結尾 HTML</span>
  <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'widgets_init'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wpdocs_theme_slug_widgets_init'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>可能會有些朋友把新增 Widget 跟新增 Widget 區塊搞混，Widget 區塊是定義要顯示 Widget 的地方，一個區塊可以有很多個 Widget 放在裡面，而 Widget 則是單一小工具，是要被放在 Widget 區塊裡面的東西。</p>
</blockquote>
<p><a href="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-18-at-09.40.44.jpg"><img src="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-18-at-09.40.44-1024x372.jpg"></a></p>
<p>Widget 區塊註冊完成之後，接下來就是要來顯示它，使用的是 dynamic_sidebar( $arg ) 這個 function，$arg 參數帶的是 Widget 區塊 name 或 ID，在呼叫前一樣可以用它來判斷 Widget 區塊是否有放入 Widget，沒有的話就可以顯示預設的內容：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">dynamic_sidebar</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'schoolpress_student_status'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">//fallback code in case my_widget_area sidebar was not found</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果要判斷 Widget 區塊是否有被註冊，可以使用 is_active_sidebar( $arg )，$arg 參數帶的是 Widget 區塊 name 或 ID：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//from twenty-thirteen/sidebar.php</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token function">is_active_sidebar</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'sidebar-2'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">:</span> <span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>tertiary<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sidebar-container<span class="token punctuation">"</span></span> <span class="token attr-name">role</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>complementary<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>sidebar-inner<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>widget-area<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">dynamic_sidebar</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'sidebar-2'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- .widget-area --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- .sidebar-inner --></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span><span class="token comment">&lt;!-- #tertiary --></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">endif</span><span class="token punctuation">;</span> <span class="token delimiter important">?></span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="不在-Widget-區塊顯示-Widget"><a href="#不在-Widget-區塊顯示-Widget" class="headerlink" title="不在 Widget 區塊顯示 Widget"></a>不在 Widget 區塊顯示 Widget</h3><p>如果你已經明確知道你想要把某個 Widget 放在特定的位置，那麼就不需要使用 Widget 區塊來顯示 Widget，可以用 the_widget( $widget, $instance, $args ) 這支 function 來直接顯示它，並且可以透過參數來指定 Widget 的設定值，參數說明如下：</p>
<p><strong>$widget</strong> - 要顯示的 Widget 類別名稱</p>
<p><strong>$instance</strong> - 要顯示的 Widget 設定的資料，以陣列表示</p>
<p><strong>$args</strong> - 要顯示的 Widget 的 HTML 標籤設定，有 before_widget、after_widget、before_title、after_title</p>
<p>以下為作者外掛 SchoolPress 顯示筆記 Widget 的範例：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//show note widget, overriding global note</span>
<span class="token function">the_widget</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'SchoolPress_Note_Widget'</span><span class="token punctuation">,</span>  <span class="token comment">//classname</span>
    <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'note'</span><span class="token operator">=></span><span class="token string single-quoted-string">''</span><span class="token punctuation">)</span><span class="token punctuation">,</span>                <span class="token comment">//instance vars</span>
    <span class="token keyword">array</span><span class="token punctuation">(</span>                       <span class="token comment">//widget vars</span>
    <span class="token string single-quoted-string">'before_widget'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'after_widget'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'before_title'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span><span class="token punctuation">,</span>
        <span class="token string single-quoted-string">'after_title'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">''</span>
    <span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Dashboard-Widget-API"><a href="#Dashboard-Widget-API" class="headerlink" title="Dashboard Widget API"></a>Dashboard Widget API</h2><p>控制台 Widget 是當管理者登入 WordPress 後台後第一眼所看到的各種小工具，預設狀態下會有網站概況、網站活動、快速草稿等等的 Widget，想要管理這些 Widget 就必須使用 Dashboard Widget API。</p>
<h3 id="移除控制台小工具"><a href="#移除控制台小工具" class="headerlink" title="移除控制台小工具"></a>移除控制台小工具</h3><p>控制台小工具主要是用 meta box 來進行設定，下面是每個內建小工具名稱：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// Main column (left): </span>
<span class="token comment">// 更新瀏覽器通知</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'normal'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard_browser_nag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
<span class="token comment">// 更新 PHP 版本通知</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'normal'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'high'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard_php_nag'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> 
 
<span class="token comment">// 網站概況</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'normal'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'core'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard_right_now'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 多站網站概況</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'normal'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'core'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'network_dashboard_right_now'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 網站活動</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'normal'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'core'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard_activity'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 網站狀態</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'normal'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'core'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'health_check_status'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
 
<span class="token comment">// Side Column (right): </span>
<span class="token comment">// WordPress 活動及新聞</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'side'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'core'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard_primary'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 快速草稿</span>
<span class="token variable">$wp_meta_boxes</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'side'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'core'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'dashboard_quick_press'</span><span class="token punctuation">]</span><span class="token punctuation">;</span> </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果要移除它們的話，使用 remove_meta_box( $id, $screen, $context ) 這支 function，參數 $id 為小工具的名稱，像是 dashboard_activity、health_check_status，$screen 為要移除的 meta box 的所在頁面，所以是 dashboard，$context 為小工具的位置，可能為 normal、side、advanced。</p>
<p>如果要移除所有預設的控制台小工具，可以使用 wp_dashboard_setup 這支 action，範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token keyword">function</span> <span class="token function">wporg_remove_all_dashboard_metaboxes</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// Remove Welcome panel</span>
    <span class="token function">remove_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'welcome_panel'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wp_welcome_panel'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Remove the rest of the dashboard widgets</span>
    <span class="token function">remove_meta_box</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'dashboard_primary'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'side'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">remove_meta_box</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'dashboard_quick_press'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'side'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">remove_meta_box</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'health_check_status'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'normal'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">remove_meta_box</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'dashboard_right_now'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'normal'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">remove_meta_box</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'dashboard_activity'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'normal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp_dashboard_setup'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'wporg_remove_all_dashboard_metaboxes'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>因為書中範例比較舊，有些 Widget 已經不存在了，所以這邊的範例是使用官方 Handbook 的說明，新版的可以參考這邊—&gt;<a target="_blank" rel="noopener" href="https://developer.wordpress.org/apis/handbook/dashboard-widgets/">https://developer.wordpress.org/apis/handbook/dashboard-widgets/</a></p>
</blockquote>
<p>如果有啟用多站網路功能的話，會有一些不同的控制台小工具，要全部移除的話參考下面範例：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//Remove network dashboard widgets</span>
<span class="token keyword">function</span> <span class="token function">sp_remove_network_dashboard_widgets</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token function">remove_meta_box</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'network_dashboard_right_now'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard-network'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'normal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">remove_meta_box</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'dashboard_plugins'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard-network'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'normal'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">remove_meta_box</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'dashboard_primary'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard-network'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'side'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">remove_meta_box</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'dashboard_secondary'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'dashboard-network'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'side'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_network_dashboard_setup'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_remove_network_dashboard_widgets'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>使用 remove_meta_box( $id, $screen, $context ) 也可以移除其他後台頁面的顯示，只要在 $screen 參數這邊指定不同的位置即可，$screen 可以是字串或是用陣列來指定多個頁面，$screen 可選參數如下：</p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-27-at-09.08.42.jpg"></p>
<p>Contributed by <a target="_blank" rel="noopener" href="https://profiles.wordpress.org/ramiy/">Rami Yushuvaev</a></p>
<h3 id="新增控制台小工具"><a href="#新增控制台小工具" class="headerlink" title="新增控制台小工具"></a>新增控制台小工具</h3><p>可以使用 wp_add_dashboard_widget() 來新增控制台小工具，它利用了 add_meta_box() 來建立，wp_add_dashboard_widget() 帶有五個參數：</p>
<p><strong>$widget_id</strong> - 必填，小工具 ID，可以提供給 CSS 作為樣式選擇的類別名稱</p>
<p><strong>$widget_name</strong> - 必填，小工具名稱，會顯在在小工具的視窗的標頭</p>
<p><strong>$callback</strong> - 必填，輸出小工具的顯示內容</p>
<p><strong>$control_callback</strong> - 選填，設定小工具的控制功能</p>
<p><strong>$callback_args</strong> - 選填，要提供給 callback function 的參數</p>
<p>下面範例作者使用 wp_add_dashboard_widget() 來顯示學生作業的提交狀態：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
    Add dashboard widgets
*/</span>
<span class="token keyword">function</span> <span class="token function">sp_add_dashboard_widgets</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token function">wp_add_dashboard_widget</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'schoolpress_assignments'</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'Assignments'</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'sp_assignments_dashboard_widget'</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'sp_assignments_dashboard_widget_configuration'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'wp_dashboard_setup'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_add_dashboard_widgets'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
Assignments dashboard widget
*/</span>
<span class="token comment">//widget</span>
<span class="token keyword">function</span> <span class="token function">sp_assignments_dashboard_widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$options</span> <span class="token operator">=</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"assignments_dashboard_widget_options"</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'course_id'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token variable">$group</span> <span class="token operator">=</span> <span class="token function">groups_get_group</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'group_id'</span><span class="token operator">=></span><span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'course_id'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$group</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"Showing assignments for class "</span> <span class="token operator">.</span>
<span class="token variable">$group</span><span class="token operator">-></span><span class="token property">name</span> <span class="token operator">.</span> <span class="token string double-quoted-string">".&lt;br />..."</span><span class="token punctuation">;</span>
<span class="token comment">/*
get assignments for this group and list their status
*/</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">else</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"Showing all assignments.&lt;br />..."</span><span class="token punctuation">;</span>
<span class="token comment">/*
get all assignments and list their status
*/</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token comment">//configuration</span>
<span class="token keyword">function</span> <span class="token function">sp_assignments_dashboard_widget_configuration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//get old settings or default to empty array</span>
<span class="token variable">$options</span> <span class="token operator">=</span> <span class="token function">get_option</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"assignments_dashboard_widget_options"</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//saving options?</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token keyword">isset</span><span class="token punctuation">(</span> <span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assignments_dashboard_options_save'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token comment">//get course_id</span>
<span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'course_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">intval</span><span class="token punctuation">(</span>
<span class="token variable">$_POST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'assignments_dashboard_course_id'</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//save it</span>
<span class="token function">update_option</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"assignments_dashboard_widget_options"</span><span class="token punctuation">,</span> <span class="token variable">$options</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">//show options form</span>
<span class="token variable">$groups</span> <span class="token operator">=</span> <span class="token function">groups_get_groups</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'orderby'</span><span class="token operator">=></span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'order'</span><span class="token operator">=></span><span class="token string single-quoted-string">'ASC'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>p</span><span class="token punctuation">></span></span>Choose a class/group to show assignments from.<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>p</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>feature_post_class_wrap<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>label</span><span class="token punctuation">></span></span>Class<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>label</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>select</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>assignments_dashboard_course_id<span class="token punctuation">"</span></span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token punctuation">"</span></span> <span class="token attr-name"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">selected</span><span class="token punctuation">(</span> <span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'course_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">""</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></span><span class="token punctuation">></span></span>
All Classes
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token variable">$groups</span> <span class="token operator">=</span> <span class="token function">groups_get_groups</span><span class="token punctuation">(</span> <span class="token keyword">array</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'orderby'</span><span class="token operator">=></span><span class="token string single-quoted-string">'name'</span><span class="token punctuation">,</span>
<span class="token string single-quoted-string">'order'</span><span class="token operator">=></span><span class="token string single-quoted-string">'ASC'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$groups</span> <span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span> <span class="token variable">$groups</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'groups'</span><span class="token punctuation">]</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span> <span class="token variable">$groups</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'groups'</span><span class="token punctuation">]</span> <span class="token keyword">as</span> <span class="token variable">$group</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>option</span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token function">intval</span><span class="token punctuation">(</span> <span class="token variable">$group</span><span class="token operator">-></span><span class="token property">id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span><span class="token punctuation">"</span></span>
<span class="token attr-name"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token function">selected</span><span class="token punctuation">(</span> <span class="token variable">$options</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'course_id'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token variable">$group</span><span class="token operator">-></span><span class="token property">id</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span></span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span> <span class="token keyword">echo</span> <span class="token variable">$group</span><span class="token operator">-></span><span class="token property">name</span><span class="token punctuation">;</span><span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>option</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>select</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>hidden<span class="token punctuation">"</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>assignments_dashboard_options_save<span class="token punctuation">"</span></span> <span class="token attr-name">value</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>1<span class="token punctuation">"</span></span> <span class="token punctuation">/></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>呈現效果如下：</p>
<p><img src="https://oberonlai.blog/wp-content/uploads/2020/05/CleanShot-2020-05-27-at-09.29.38.jpg"></p>
<blockquote>
<p>這個範例個人覺得不太好，一次做太多事了，可以參考這篇 <a target="_blank" rel="noopener" href="https://www.sitepoint.com/wordpress-dashboard-widgets-api/">https://www.sitepoint.com/wordpress-dashboard-widgets-api/</a> 裡面的 Displaying an RSS Feed in a Dashboard Widget 會比較單純的多。</p>
</blockquote>
<h3 id="設定頁面-API"><a href="#設定頁面-API" class="headerlink" title="設定頁面 API"></a>設定頁面 API</h3><p>如果你是在開發外掛的話，有時候會需要提供一些設定項目來讓使用者改變外掛的功能，這個時候就可以用設定頁面 API ( Settings API ) 來設計外掛的設定選單與表單。</p>
<p>但在使用它之前，可以先思考是否有必要另外新增頁面來處理這些設定，如果是沒有要讓使用者自行修改的話，直接使用全域變數 global 來存放設定值是比較好的方法：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token keyword">global</span> <span class="token variable">$schoolpress_settings</span><span class="token punctuation">;</span>
<span class="token variable">$schoolpress_settings</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'info_email'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'info@schoolpress.me'</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'info_email_name'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'SchoolPress'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>以下四種情境可能不需要用到設定頁面：</p>
<ol>
<li> 外掛只會在團隊內部使用</li>
<li> 外掛設定的修改者是開發者</li>
<li> 外掛設定的內容不會因為主機環境不同而有所不同</li>
<li> 外掛設定的內容只是為了前一版本的修改</li>
</ol>
<p>除了把設定項存在 global 外，也可以考慮新增 Hook 或 filter 來改變設定內容。舉例：有一支可以產出 Word 檔的外掛需要限制特定的管理權限才可以使用，如果是用設定頁面來做的話，可能會有所有權限 ( Capability ) 的 Checkbox 來提供給管理者勾選，被勾選到的才能使用產出 Word 檔。</p>
<p>在這種情況下自訂一個 apply_filter 來讓開發者可以把允許的權限 Hook 到這個 filter 上會更方便，自訂 filter 的範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//don't require any caps by default, but allow developers to add checks</span>
<span class="token variable">$caps</span> <span class="token operator">=</span> <span class="token function">apply_filters</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wpdoc_caps'</span><span class="token punctuation">,</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$caps</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">//guilty until proven innocent</span>
  <span class="token variable">$hascap</span> <span class="token operator">=</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

  <span class="token comment">//must be logged in to have any caps at all</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">is_user_logged_in</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">//make sure the current user has one of the caps</span>
    <span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token variable">$caps</span> <span class="token keyword">as</span> <span class="token variable">$cap</span><span class="token punctuation">)</span>
    <span class="token punctuation">&#123;</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">current_user_can</span><span class="token punctuation">(</span><span class="token variable">$cap</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">&#123;</span>
        <span class="token variable">$hascap</span> <span class="token operator">=</span> <span class="token constant boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span><span class="token punctuation">;</span>  <span class="token comment">//stop checking</span>
      <span class="token punctuation">&#125;</span>
    <span class="token punctuation">&#125;</span>
  <span class="token punctuation">&#125;</span>

  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token variable">$hascap</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token comment">//don't show them the file</span>
    <span class="token function">header</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'HTTP/1.1 503 Service Unavailable'</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span><span class="token punctuation">,</span> <span class="token number">503</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">echo</span> <span class="token string double-quoted-string">"HTTP/1.1 503 Service Unavailable"</span><span class="token punctuation">;</span>
    <span class="token keyword">exit</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>接下來使用者 ( 開發者 ) 就可以使用 wpdoc_caps 這個 filter 來寫入允許的 capability：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
 <span class="token comment">//require any user account</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wpdoc_caps'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$caps</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'read'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//require admin account</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wpdoc_caps'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$caps</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'manage_options'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//authors only or users with a custom capability (doc)</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wpdoc_caps'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$caps</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token keyword">return</span> <span class="token keyword">array</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'edit_post'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'doc'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="新增原生設定頁面"><a href="#新增原生設定頁面" class="headerlink" title="新增原生設定頁面"></a>新增原生設定頁面</h3><p>在經過審慎評估後，我們就可以來新增設定頁面，通常有兩種作法，一種是使用 WordPress 提供的 Settings API，這樣做好處是可以讓其他開發者比較好理解，甚至針對你的外掛寫附加套件。</p>
<p>使用 Settings API 同時也確保在介面的呈現上與 WordPress 後台有一致的風格，你不會希望當使用者要使用你的外掛時還必須要學習新的操作介面。</p>
<h3 id="新增客製化設定頁面"><a href="#新增客製化設定頁面" class="headerlink" title="新增客製化設定頁面"></a>新增客製化設定頁面</h3><p>如果設定頁面單純，用 WordPress 原生設定介面就可以處理的話當然最好，但有時候外掛功能很多，設定項目包含許多不同的面向，需要把他們進行分類，這時候就必須考慮客製化設定頁面。</p>
<p>雖然 Settings API 很靈活，可以針對個別區塊、欄位來顯示設定內容，在只需要一兩個設定區塊的狀況下是非常好用的，但如果是要開發一套應用程式的設定頁面，你可能需要不同的邏輯來顯示它們，客製化設定頁面是唯一辦法。</p>
<p>客製化設定頁面不會太困難，只要新增選單並且使用自訂設定頁面的 PHP 檔後，再透過 callback function 來呼叫它們，以及照著下方的原則來處理即可：</p>
<ul>
<li>  即使你的設定頁面是自己手刻 Layout，也還是可以使用原生的設定區塊與項目</li>
<li>  絕對要記得處理表單資料的 sanitize 與同源驗證的 nonces 來確保設定頁的安全性</li>
<li>  適時的加入 Hook 來提供給其他開發者使用</li>
<li>  使用與 WordPress 相同的 HTML 標籤與 Class 名稱，以確保在介面上風格可以一致</li>
</ul>
<p>客製化設定頁面的設計可以參考購物車外掛的介面，因為它們是功能很多的外掛，設定項目也相對複雜許多，可以餐考 WooCoomerce 與 Paid Memberships Pro 等同類型的外掛。</p>
<blockquote>
<p>Settings API 的具體用法可以參考 Plugin Handbook 裡面的 Settings 章節 —&gt; <a target="_blank" rel="noopener" href="https://developer.wordpress.org/plugins/settings/settings-api/">https://developer.wordpress.org/plugins/settings/settings-api/</a></p>
</blockquote>
<h2 id="Rewrite-API"><a href="#Rewrite-API" class="headerlink" title="Rewrite API"></a>Rewrite API</h2><p>通常伺服器會有覆寫網址的功能來改變網址的結構，如果是 Apache 的話是使用 mod_rewrite 模組，設定覆寫規則的檔案是 .htaccess，WordPress 標準的 Rewrite 規則如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php">\<span class="token comment"># BEGIN WordPress</span>
<span class="token operator">&lt;</span>IfModule mod_rewrite<span class="token operator">.</span>c<span class="token operator">></span>
RewriteEngine On
RewriteBase <span class="token operator">/</span>
RewriteRule <span class="token operator">^</span>index\\<span class="token operator">.</span><span class="token class-name type-declaration">php</span>$ <span class="token operator">-</span> <span class="token punctuation">[</span><span class="token constant">L</span><span class="token punctuation">]</span>
RewriteCond <span class="token operator">%</span><span class="token punctuation">&#123;</span><span class="token constant">REQUEST_FILENAME</span><span class="token punctuation">&#125;</span> <span class="token operator">!</span><span class="token operator">-</span>f
RewriteCond <span class="token operator">%</span><span class="token punctuation">&#123;</span><span class="token constant">REQUEST_FILENAME</span><span class="token punctuation">&#125;</span> <span class="token operator">!</span><span class="token operator">-</span>d
RewriteRule <span class="token operator">.</span> <span class="token operator">/</span>index<span class="token operator">.</span>php <span class="token punctuation">[</span><span class="token constant">L</span><span class="token punctuation">]</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>IfModule<span class="token operator">></span>
<span class="token comment"># END WordPress</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果想要理解每一行在表示什麼可以參考 David Walsh 的這一篇文章：<a target="_blank" rel="noopener" href="https://davidwalsh.name/wordpress-htaccess">https://davidwalsh.name/wordpress-htaccess</a></p>
<p>一般來說，這些規則主要是在負責把所有使用者瀏覽我們網站所造訪的網址，統一轉到 index.php 這個檔案，然後 WordPress 會透過內建的路由機制，去解析造訪網址然後找到對應的模板後顯示出來。</p>
<p>譬如說當使用者輸入網址 <a target="_blank" rel="noopener" href="https://abc.com/about">https://abc.com/about</a> 的時候，會先去到 <a target="_blank" rel="noopener" href="https://abc.com/index.php%EF%BC%8C%E7%84%B6%E5%BE%8C">https://abc.com/index.php，然後</a> WordPress 會去尋找頁面名稱帶有 about 的頁面或文章，找到後再返回給使用者進行瀏覽。</p>
<p>在預設情況下 WordPress 就會完成這樣的路由機制，所以當你想要指定一些特定網址去做某些事，就是 Rewrite API 派上用場的時候了。</p>
<h3 id="新增-Rewrite-Rule"><a href="#新增-Rewrite-Rule" class="headerlink" title="新增 Rewrite Rule"></a>新增 Rewrite Rule</h3><p>可以透過 add_rewrite_rule( $rule, $rewrite, $position ) 來直接新增，參數說明如下：</p>
<p><strong>$rule</strong> - 使用正規表達式來找尋網址中符合條件的目標</p>
<p><strong>$rewrite</strong> - 找到目標後覆寫的網址內容，可以使用 $matches 陣列帶入 $rule 找到的字串</p>
<p><strong>$position</strong> - 設定該 Rewrite Rule 的權重是要在 WordPress 內建的之上 ( top ) 或之下 ( bottom )</p>
<blockquote>
<p>要注意 Rewrite 跟 Redirect 是不一樣的：Rewrite 是把同個頁面的網址做結構上的改變，處理完之後不會去其他頁面，還是會停留在同一頁，而 Redirect 是改變網址後跳轉到其他頁面。</p>
</blockquote>
<p>如果你想讓你的聯絡表單網址，可以使用目錄的方式直接帶入表單主旨，像是 <a target="_blank" rel="noopener" href="https://abc.com/contact/special-offer%EF%BC%8C%E7%95%B6%E4%BD%BF%E7%94%A8%E8%80%85%E9%80%A0%E8%A8%AA%E9%80%99%E5%80%8B%E7%B6%B2%E5%9D%80%E7%9A%84%E6%99%82%E5%80%99%EF%BC%8C%E9%80%B2%E5%85%A5%E8%A1%A8%E5%96%AE%E9%A0%81%E9%9D%A2%E6%99%82%E4%B8%BB%E6%97%A8%E6%AC%84%E4%BD%8D%E5%B0%B1%E6%9C%83%E8%87%AA%E5%8B%95%E8%BC%B8%E5%85%A5">https://abc.com/contact/special-offer，當使用者造訪這個網址的時候，進入表單頁面時主旨欄位就會自動輸入</a> special-offer 這幾個字，範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token function">add_rewrite_rule</span><span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'/contact/([^/]+)/?'</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'index.php?name=contact&amp;subject='</span> <span class="token operator">.</span> <span class="token variable">$matches</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'top'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add_rewrite_rule</span><span class="token punctuation">(</span>
<span class="token function">flush_rewrite_rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>正規表達式是使用 Rewrite API 的必備技能，如果你跟我一樣對它很苦手的話，我都用這個軟體作弊XD —&gt; <a target="_blank" rel="noopener" href="https://www.apptorium.com/expressions">https://www.apptorium.com/expressions</a>，它超級好用，只要輸入條件就會立即顯示是否有符合的字串，我常常就是亂湊一通就慢慢能湊到我要的寫法，大推！</p>
</blockquote>
<h3 id="刷新-Rewrite-Rule"><a href="#刷新-Rewrite-Rule" class="headerlink" title="刷新 Rewrite Rule"></a>刷新 Rewrite Rule</h3><p>WordPress 預設會把 Rewrite rule 加到快取機制裡面，所以當新增的時候記得要刷新 Rewrite rule 才會產生作用，如果是開發外掛的話，要保存自己寫的 rule 通常會以下面三種方式來新增：</p>
<ol>
<li> 啟用外掛時新增 rule，同時間使用 flush_rewrite_rules() 來刷新它</li>
<li> 使用 Hook init 來新增 rule，以防被後台的永久連結設定或是其他的外掛所刷新</li>
<li> 在停用外掛時使用 flush_rewrite_rules() 來移除 rule</li>
</ol>
<p>具體範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//Add rule and flush on activation.</span>
<span class="token keyword">function</span> <span class="token function">sp_activation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token function">add_rewrite_rule</span><span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'/contact/([^/]+)/?'</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'index.php?name=contact&amp;subject='</span> <span class="token operator">.</span> <span class="token variable">$matches</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'top'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">flush_rewrite_rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">register_activation_hook</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_activation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/*
  Add rule on init in case another plugin flushes,
  but don't flush cause it's expensive
*/</span>
<span class="token keyword">function</span> <span class="token function">sp_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token function">add_rewrite_rule</span><span class="token punctuation">(</span>
  <span class="token string single-quoted-string">'/contact/([^/]+)/?'</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'index.php?name=contact&amp;subject='</span> <span class="token operator">.</span> <span class="token variable">$matches</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string single-quoted-string">'top'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'init'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_init'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//Flush rewrite rules on deactivation to remove our rule.</span>
<span class="token keyword">function</span> <span class="token function">sp_deactivation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token function">flush_rewrite_rules</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">register_deactivation_hook</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_deactivation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="其他-Rewrite-相關-function"><a href="#其他-Rewrite-相關-function" class="headerlink" title="其他 Rewrite 相關 function"></a>其他 Rewrite 相關 function</h3><p>除了上面介紹的 add_rewrite_rule() 以外，WordPress 還提供了其他 function 來改寫 URL：</p>
<p><strong>add_rewrite_tag()</strong> - 在網址結構中加入特定資料</p>
<p><strong>add_custom_endpoint()</strong> - 在網址最後加入資料</p>
<p><strong>add_feed()</strong> - 自訂 RSS 網址的結構</p>
<blockquote>
<p>推薦 Envato Tuts+ 的這篇文章 <a target="_blank" rel="noopener" href="https://code.tutsplus.com/articles/the-rewrite-api-the-basics--wp-25474">https://code.tutsplus.com/articles/the-rewrite-api-the-basics–wp-25474</a>，每個用法都有具體的範例跟說明，而且解釋的比書中以及 Codex 來得清楚許多。</p>
</blockquote>
<h2 id="WP-Cron"><a href="#WP-Cron" class="headerlink" title="WP-Cron"></a>WP-Cron</h2><p>Cron 是作業系統內建的定時器，只要設定好時間就能自動執行指定的任務，通常會用在像是每天自動發送業績報表給管理員、同步從第三方 API 獲取的資料、CPU 的系統監控回報等等的情境上。</p>
<p>而 WP-Cron 是 WordPress 內建的定時器，要使用 WP-Cron 有三個步驟，第一個是建立定時器並設定執行時間，第二是把要執行的 function 掛到這個定時器裡面，最後是把實際要執行的任務寫入這個 function 之中，範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// 當外掛啟用時建立定時器</span>
<span class="token keyword">function</span> <span class="token function">sp_activation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token comment">//do_action('sp_daily_cron'); 定時器名稱叫做 sp_daily_cron</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span> <span class="token function">wp_next_scheduled</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'sp_daily_cron'</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      <span class="token function">wp_schedule_event</span><span class="token punctuation">(</span> <span class="token function">strtotime</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'12:00:00'</span> <span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'daily'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_daily_cron'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
   <span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">register_activation_hook</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_activation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 停用外掛時移除定時器</span>
<span class="token keyword">function</span> <span class="token function">sp_deactivation</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token function">wp_clear_scheduled_hook</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'sp_daily_cron'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">register_deactivation_hook</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_deactivation'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 要執行的任務</span>
<span class="token keyword">function</span> <span class="token function">sp_daily_cron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token comment">//do this daily</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"sp_daily_cron"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"sp_daily_cron"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 把任務放到定時器裡面</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>建立定時器使用 wp_schedule_event( $timestamp, $recurrence, $hook, $args ) 這支 function，參數 $timestamp 為第一次執行的時間，通常使用 time() 即可，$recurrence 為多久後再執行一次的間隔，可以是每小時 hourly、每天 daily、每兩天 twicedaily，如果要自訂間隔可以使用來指定週期。</p>
<p>參數 $hook 是定時器的 hook 名稱，讓執行任務的 function 可以掛在這個定時器裡面，$args 為當 hook 發生時可以傳給任務 function 的參數。</p>
<p>為了易於辨識，通常定時器的名稱會以執行週期來命名。以 sp_daily_cron，可以很直覺的知道這是每天會執行一次的定時器，便於讓其他任務也能使用它。</p>
<blockquote>
<p>要查詢已經註冊過的定時器可以使用 WP Control <a target="_blank" rel="noopener" href="https://wordpress.org/plugins/wp-crontrol/">https://wordpress.org/plugins/wp-crontrol/</a>，它會幫你列出所有的定時器，另外還可以用 Cron Logger <a target="_blank" rel="noopener" href="https://wordpress.org/plugins/cron-logger/">https://wordpress.org/plugins/cron-logger/</a> 來查看定時器的工作紀錄。</p>
</blockquote>
<h3 id="自訂排程間隔時間"><a href="#自訂排程間隔時間" class="headerlink" title="自訂排程間隔時間"></a>自訂排程間隔時間</h3><p>預設情況下，wp_schedule_event() 只有提供每小時、每天與每兩天這三種，如果要自訂新的間隔時間，可以使用 cron_schedules，範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//add a monthly interval to use in cron jobs</span>
<span class="token keyword">function</span> <span class="token function">sp_cron_schedules</span><span class="token punctuation">(</span><span class="token variable">$schedules</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token variable">$schedules</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'monthly'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string single-quoted-string">'interval'</span> <span class="token operator">=></span> <span class="token number">60</span><span class="token operator">*</span><span class="token number">60</span><span class="token operator">*</span><span class="token number">24</span><span class="token operator">*</span><span class="token number">30</span><span class="token punctuation">,</span> <span class="token comment">//really 30 days</span>
<span class="token string single-quoted-string">'display'</span> <span class="token operator">=></span> <span class="token string single-quoted-string">'Once a Month'</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'cron_schedules'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_cron_schedules'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>如果要取得是一週當中第幾天來執行排程，可以使用 date() 日期函式來判斷，以下範例為每週的第一天執行：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//run on Mondays</span>
<span class="token keyword">function</span> <span class="token function">sp_monday_cron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token comment">//get day of the week, 0-6, starting with Sunday</span>
<span class="token variable">$weekday</span> <span class="token operator">=</span> <span class="token function">date</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"w"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//is it Monday?</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$weekday</span> <span class="token operator">==</span> <span class="token string double-quoted-string">"1"</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token comment">//execute this code on Mondays</span>
<span class="token punctuation">&#125;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"sp_daily_cron"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"sp_monday_cron"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>上述範例為每隔一段時間執行任務，另外也可以使用 wp_schedule_single_event() 來預約在未來的某個時間點來完成任務的執行，譬如說可以設定當作者發布文章過後的一個小時自動發信給審核者，讓作者有時間可以進行潤稿的作業。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
 <span class="token keyword">function</span> <span class="token function">do_this_in_an_hour</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
 
    <span class="token comment">// do something</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'my_new_event'</span><span class="token punctuation">,</span><span class="token string single-quoted-string">'do_this_in_an_hour'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// put this line inside a function, </span>
<span class="token comment">// presumably in response to something the user does</span>
<span class="token comment">// otherwise it will schedule a new event on every page visit</span>
 
<span class="token function">wp_schedule_single_event</span><span class="token punctuation">(</span> <span class="token function">time</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">3600</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'my_new_event'</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
 
<span class="token comment">// time() + 3600 = one hour from now.</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="使用主機排程來執行-wp-cron"><a href="#使用主機排程來執行-wp-cron" class="headerlink" title="使用主機排程來執行 wp-cron"></a>使用主機排程來執行 wp-cron</h3><p>wp-cron 是當頁面有載入時才會開始檢查是否有排程任務需要執行，所以當半夜網站沒人或是頁面被快取不需重新載入的情況下，wp-cron 就很有可能不會被觸發，因此需要確實執行的排程任務最好還是要透過主機的 crontab 來處理。</p>
<p>要使用主機的 crontab 首先要再 wp-config.php 加入停用 wp-cron 的設定：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token function">disable</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"DISABLE_WP_CRON"</span><span class="token punctuation">,</span> <span class="token constant boolean">true</span> <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>接下來在主機設定 crontab 並使用 wget 來造訪 wp-cron.php 頁面：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">0</span> <span class="token number">0</span> * * * <span class="token function">wget</span> -O - -q -t <span class="token number">1</span> https://yoursite.com/wp-cron.php?doing_wp_cron<span class="token operator">=</span><span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p>0 0 * * * 五個參數代表分、時、日、月、星期幾，所以這個範例表示的是 0 時 0 分，也就是午夜十二點，後面的星號則代表不指定，wget 則是讓主機前往特定網址進行下載動作，-O 是設定下載後的檔案名稱，-q 是啟用 quite 模式，這會關閉每次排程執行完成後的通知。</p>
<p>-t 代表如果 wget 執行失敗的的話重新執行的次數，範例中設定 -t 1，則代表只會執行一次，萬一失敗的話就不會再重複執行。如果 wp-cron.php 無法順利造訪，就代表你的網站已經停止運作了，就不用再重複執行了。</p>
<p>網址最後接的參數 ?doing_wp_cron 是 wp-cron.php 執行前會先去檢查的參數，要注意的地方是記得把 wp-cron.php 排除在被快取的檔案之中，才能有效的被觸發。</p>
<blockquote>
<p>關於 crontab 與 get 可以參考 Wang 大的兩篇好文：</p>
<p><a target="_blank" rel="noopener" href="https://blog.gtwang.org/linux/linux-crontab-cron-job-tutorial-and-examples/">https://blog.gtwang.org/linux/linux-crontab-cron-job-tutorial-and-examples/</a><br><a target="_blank" rel="noopener" href="https://blog.gtwang.org/linux/linux-wget-command-download-web-pages-and-files-tutorial-examples/">https://blog.gtwang.org/linux/linux-wget-command-download-web-pages-and-files-tutorial-examples/</a></p>
</blockquote>
<h3 id="不使用-wp-cron-只用-crontab"><a href="#不使用-wp-cron-只用-crontab" class="headerlink" title="不使用 wp-cron 只用 crontab"></a>不使用 wp-cron 只用 crontab</h3><p>如果你的外掛沒有要發佈或是使用對象是熟悉 Linux 指令的工程師，那麼就不需要用到 wp-cron 而直接使用 crontab 去執行排程任務即可，只要透過帶有參數的 URL 去觸發 callback function，範例如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//run on Mondays</span>
<span class="token keyword">function</span> <span class="token function">sp_monday_cron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token comment">//check that cron param was passed in</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token keyword">empty</span><span class="token punctuation">(</span><span class="token variable">$_REQUEST</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'sp_cron_monday'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token keyword">return</span> <span class="token constant boolean">false</span><span class="token punctuation">;</span>

<span class="token comment">//execute this code on Mondays</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"init"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"sp_monday_cron"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>先把要執行的任務 hook 到 init 上面，當 URL 帶有 sp_cron_monday 這個參數的時候就會觸發，然後 crontab 設定如下：</p>
<p>0 0 * * 1 wget -O  - q -t 1 <a target="_blank" rel="noopener" href="https://yoursite.com/?sp_cron_monday=1">https://yoursite.com?sp_cron_monday=1</a></p>
<p>這邊執行設定 0 0 * * 1 最後面的 1 代表是星期幾，0 的話是星期日，1 的話是星期一，其他以此類推。</p>
<h2 id="WP-MAIL-發信"><a href="#WP-MAIL-發信" class="headerlink" title="WP_MAIL 發信"></a>WP_MAIL 發信</h2><p>WordPress 使用 wp_mail 來取代 php 原生的 mail() 函式，用法為 wp_mail( $to, $subject, $message, $headers, $attachments )。</p>
<p>參數 $to 為收件人的 email，可以同時寄送給多筆信箱，中間以「,」區隔，或是使用陣列來存放多筆 email address，$subject 為信件主旨，$message 為信件內容，預設格式為純文字，如果需要在信件中寫 HTML 則需要另行設定。</p>
<p>$headers 為信件標頭，可以寫入 email 的相關資訊，像是郵件副本、密件副本等等，$attachments 為附加檔案，可以是單一檔案或是用陣列夾帶多筆。</p>
<p>相較於 PHP 的 mail()，wp_mail() 多了幾個方便的功能：</p>
<ul>
<li>  帶有 hook，wp_mail filter 可以傳送值給 wp_mail()，或是統一修改全站發送郵件的寄件人 email 與寄件人名稱</li>
<li>  可附加一個或多個檔案，使用 mail() 會很複雜，wp_mail() 使用 PHPMailer 來簡化附加檔案的作業</li>
</ul>
<h3 id="優化電子郵件"><a href="#優化電子郵件" class="headerlink" title="優化電子郵件"></a>優化電子郵件</h3><p>在預設情況下，WordPress 發送的電子郵件寄件人是用管理員的信箱，以及使用 WordPress 當作寄件人名稱，我們可以透過 wp_mail_from 與 wp_mail_from_name 這兩個 filter 來進行修改。</p>
<p>另外也可以使用 wp_main_content_type filter 來修改郵件格式，讓內文可以支援 HTML，還可以使用 wp_mail filter 來加入郵件內容的頁首與頁尾，讓 email 整體看起來更加專業：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">// 修改寄件人電子郵件與名稱</span>
<span class="token keyword">function</span> <span class="token function">sp_wp_mail_from</span><span class="token punctuation">(</span><span class="token variable">$from_email</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token string single-quoted-string">'info@schoolpress.me'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token keyword">function</span> <span class="token function">sp_wp_mail_from_name</span><span class="token punctuation">(</span><span class="token variable">$from_name</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">return</span> <span class="token string single-quoted-string">'SchoolPress'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_mail_from'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_wp_mail_from'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_mail_from_name'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_wp_mail_from_name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 修改電子郵件格式</span>
<span class="token keyword">function</span> <span class="token function">sp_wp_mail_content_type</span><span class="token punctuation">(</span> <span class="token variable">$content_type</span> <span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$content_type</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'text/plain'</span><span class="token punctuation">)</span>
  <span class="token punctuation">&#123;</span>
    <span class="token variable">$content_type</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'text/html'</span><span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span>
  <span class="token keyword">return</span> <span class="token variable">$content_type</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_mail_content_type'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_wp_mail_content_type'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 自訂頁首與頁尾</span>
<span class="token keyword">function</span> <span class="token function">sp_wp_mail_header_footer</span><span class="token punctuation">(</span><span class="token variable">$email</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">//get header</span>
  <span class="token variable">$headerfile</span> <span class="token operator">=</span> <span class="token function">get_stylesheet_directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"email_header.html"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$headerfile</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$headerfile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token variable">$header</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

  <span class="token comment">//get footer</span>
  <span class="token variable">$footerfile</span> <span class="token operator">=</span> <span class="token function">get_stylesheet_directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"email_footer.html"</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token function">file_exists</span><span class="token punctuation">(</span><span class="token variable">$footerfile</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token variable">$footer</span> <span class="token operator">=</span> <span class="token function">file_get_contents</span><span class="token punctuation">(</span><span class="token variable">$footerfile</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">else</span>
    <span class="token variable">$footer</span> <span class="token operator">=</span> <span class="token string double-quoted-string">""</span><span class="token punctuation">;</span>

  <span class="token comment">//update message</span>
  <span class="token variable">$email</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token variable">$header</span> <span class="token operator">.</span> <span class="token variable">$email</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'message'</span><span class="token punctuation">]</span> <span class="token operator">.</span> <span class="token variable">$footer</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token variable">$email</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_mail'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'sp_wp_mail_header_footer'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="檔案-Header-API"><a href="#檔案-Header-API" class="headerlink" title="檔案 Header API"></a>檔案 Header API</h2><p>在 WordPress 的佈景主題或是外掛之中，都會有一段註解來說明這支程式的資訊，而用 get_plugin_data()、wp_get_theme()、get_file_data() 這三個 API 就可以取得這些資訊。</p>
<p>像是外掛的檔案 Header 資訊如下：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token comment">/**
 * Plugin Name: Paid Memberships Pro
 * Plugin URI: https://www.paidmembershipspro.com
 * Description: The most complete member management and membership subscriptions plugin for WordPress.
 * Version: 2.3.4
 * Author: Stranger Studios
 * Author URI: https://www.strangerstudios.com
 * Text Domain: paid-memberships-pro
 * Domain Path: /languages
 */</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>要取得裡面的資訊使用 get_plugin_data( $plugin_file, $markup=true, $translate=true )，參數 $plugin_file 是要取得外掛的路徑，$markup 為 true 時，會把有連結的資料轉為 HTML 的連結，$translate 為 true 時，會依據 WordPress 語系的設定把 Header 資訊進行翻譯。</p>
<p>下面的範例會檢查 wp-content/plugins 裡面所有的外掛，然後把每支外掛的資訊放到一個陣列裡面：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//must include this file</span>
<span class="token keyword">require_once</span><span class="token punctuation">(</span><span class="token constant">ABSPATH</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"wp-admin/includes/plugin.php"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//remember current directory</span>
<span class="token variable">$cwd</span> <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//switch to plugin directory</span>
<span class="token variable">$plugins_dir</span> <span class="token operator">=</span> <span class="token constant">ABSPATH</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"wp-content/plugins"</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$plugins_dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>"</span><span class="token punctuation">;</span>

<span class="token comment">//loop through plugin directories and print plugin info</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"*"</span><span class="token punctuation">,</span> <span class="token constant">GLOB_ONLYDIR</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$dir</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token variable">$plugin</span> <span class="token operator">=</span> <span class="token function">get_plugin_data</span><span class="token punctuation">(</span><span class="token variable">$plugins_dir</span> <span class="token operator">.</span>
        <span class="token string double-quoted-string">"/"</span> <span class="token operator">.</span> <span class="token variable">$dir</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/"</span> <span class="token operator">.</span> <span class="token variable">$dir</span> <span class="token operator">.</span> <span class="token string double-quoted-string">".php"</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">,</span> <span class="token constant boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$plugin</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;/pre>"</span><span class="token punctuation">;</span>

<span class="token comment">//switch back to current directory just in case</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$cwd</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>同樣的，如果要取得佈景主題的檔案資訊，可以使用 wp_get_theme( $stylesheet, $theme_root )，參數 $stylesheet 為佈景主題名稱，留空的話預設值為目前使用的佈景主題，$theme_root 為佈景主題的資料夾路徑。</p>
<p>下面範例會取得佈景主題的資訊後存進一個陣列：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//remember current directory</span>
<span class="token variable">$cwd</span> <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//switch to themes directory</span>
<span class="token variable">$themes_dir</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token function">get_template_directory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$themes_dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>"</span><span class="token punctuation">;</span>

<span class="token comment">//loop through theme directories and print theme info</span>
<span class="token keyword">foreach</span><span class="token punctuation">(</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"*"</span><span class="token punctuation">,</span> <span class="token constant">GLOB_ONLYDIR</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$dir</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token variable">$theme</span> <span class="token operator">=</span> <span class="token function">wp_get_theme</span><span class="token punctuation">(</span><span class="token variable">$dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$theme</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;/pre>"</span><span class="token punctuation">;</span>

<span class="token comment">//switch back to current directory just in case</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$cwd</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="使用-get-file-data-取得檔案-Header"><a href="#使用-get-file-data-取得檔案-Header" class="headerlink" title="使用 get_file_data() 取得檔案 Header"></a>使用 get_file_data() 取得檔案 Header</h3><p>get_plugin_info() 與 wp_get_themes() 都是使用 get_file_data() 函式所寫成的，如果要取得檔案 Header 也可以直接使用它，當要開發擴充外掛需要取得主外掛的資訊時，get_file_data() 就非常好用。</p>
<p>get_file_data( $file, $default_headers, $context=’’ ) 參數 $file 為要取得的檔案資訊的路徑或檔名，$default_headers 使用陣列來指定要取得的資訊，$context 為當有不同 Header 時的辨識標籤，標籤名稱取決於 hook extra_{context}_headers 中間的 context：</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">//set headers for our files</span>
<span class="token variable">$default_headers</span> <span class="token operator">=</span> <span class="token keyword">array</span><span class="token punctuation">(</span>
<span class="token string double-quoted-string">"Title"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Title"</span><span class="token punctuation">,</span>
<span class="token string double-quoted-string">"Slug"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Slug"</span><span class="token punctuation">,</span>
<span class="token string double-quoted-string">"Version"</span> <span class="token operator">=></span> <span class="token string double-quoted-string">"Version"</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//remember current directory</span>
<span class="token variable">$cwd</span> <span class="token operator">=</span> <span class="token function">getcwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//change to reports directory</span>
<span class="token variable">$reports_dir</span> <span class="token operator">=</span> <span class="token function">dirname</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span> <span class="token operator">.</span> <span class="token string double-quoted-string">"/reports"</span><span class="token punctuation">;</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$reports_dir</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;pre>"</span><span class="token punctuation">;</span>

<span class="token comment">//loop through .php files in reports directory</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token function">glob</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"*.php"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token variable">$filename</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token variable">$data</span> <span class="token operator">=</span> <span class="token function">get_file_data</span><span class="token punctuation">(</span><span class="token variable">$filename</span><span class="token punctuation">,</span> <span class="token variable">$default_headers</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"report"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">print_r</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;/pre>"</span><span class="token punctuation">;</span>

<span class="token comment">//change back to the current directory in case someone expects the default</span>
<span class="token function">chdir</span><span class="token punctuation">(</span><span class="token variable">$cwd</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="幫佈景主題與外掛加入新的檔案-Header"><a href="#幫佈景主題與外掛加入新的檔案-Header" class="headerlink" title="幫佈景主題與外掛加入新的檔案 Header"></a>幫佈景主題與外掛加入新的檔案 Header</h3><p>要新增外掛或佈景主題的 Header，可以使用 extra_plugin_headers 與 extra_theme_headers 這兩個 filter，或是也能使用 extra_{context}_headers 來讓 get_file_data() 取得自訂的 Header。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/*
Plugin Name: Stop Plugin Updates
Plugin URI: http://bwawwp.com/plugins/stop-plugin-updates/
Description: "Allow Updates: No" i a plugin's header keeps it from updating.
Version: .1
Author: Stranger Studios
Author URI: http://www.strangerstudios.com
*/</span>

<span class="token comment">//add AllowUpdates header to plugin</span>
<span class="token keyword">function</span> <span class="token function">spu_extra_plugin_headers</span><span class="token punctuation">(</span> <span class="token variable">$headers</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$headers</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'AllowUpdates'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string double-quoted-string">"Allow Updates"</span><span class="token punctuation">;</span>
<span class="token keyword">return</span> <span class="token variable">$headers</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string double-quoted-string">"extra_plugin_headers"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"spu_extra_plugin_headers"</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="Heartbeat-API"><a href="#Heartbeat-API" class="headerlink" title="Heartbeat API"></a>Heartbeat API</h2><p>Heartbeat API 使用 Ajax 的方式實現即時的資料庫讀寫動作，當網站頁面載入時，會以每 15~30 秒的頻率觸發一次，也可以手動設定觸發頻率為 60 秒。可以使用外掛 <a target="_blank" rel="noopener" href="https://wordpress.org/plugins/heartbeat-control/">Heartbeat Control</a> 來設定觸發頻率以及開啟或關閉 Heartbeat API。</p>
<p>Heartbeat API 通常是後台會用到的功能，雖然在前台也可以用，但要謹慎的使用，因為以這麼高的頻率去存取資料庫，對於伺服器而言勢必會造成一定程度的負擔。</p>
<p>它被應用的場景最常見的就是當同時有兩位管理者要編輯同一篇文章時，後編輯者會跳出詢問是否要接管的小視窗，這個判斷機制就是使用 Heartbeat API 來進行觸發，它會定時去偵測目前文章的編輯者，所以都有另外編輯者進入時，可以很快的知道這篇文章正被其他人在編輯。</p>
<p>另外還有像是自動儲存草稿、或是有需要即時更新資料的外掛如 Google Analytics，都是它大顯身手的地方。</p>
<p>Heartbeat API 會依照以下的順序執行：</p>
<ol>
<li> 客戶端透過 jQuery 傳送資料給伺服器，事件名稱是 heartbeat-send</li>
<li> 伺服器接收到資料後透過 PHP 來處理回應，使用 heartbeat_rceived filter</li>
<li> 客戶端收到伺服器回應後使用 jQuery 來處理，事件名稱為 heartbeat-tick</li>
</ol>
<p>下面作者示範如何使用 Heartbeat API，來協助老師處理家長接送小孩時車流量的控管，透過 Heartbeat API 可以即時更新資訊以掌握家長的位置，讓小孩不用在車道上等太久以減少意外事故發生的機率。</p>
<pre class="line-numbers language-php" data-language="php"><code class="language-php"><span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token comment">/**
* Plugin Name: The Teacher Life Saver
* Plugin URI:  https://schoolpress.me/
* Description: Alert teachers of parent arrivals
* Version:     0.0.1
*/</span>

<span class="token comment">// 在後台首頁加入家長位置訊息</span>
<span class="token keyword">function</span> <span class="token function">ttls_dashboard_widget</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">global</span> <span class="token variable">$wp_meta_boxes</span><span class="token punctuation">;</span>

<span class="token comment">// widget ID, widget name, callback function</span>
<span class="token function">wp_add_dashboard_widget</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'ttls_widget'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'Student Pick Ups'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ttls_dashboard'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'wp_dashboard_setup'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ttls_dashboard_widget'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Markup for the dashboard widget</span>
<span class="token keyword">function</span> <span class="token function">ttls_dashboard</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">echo</span> <span class="token string double-quoted-string">"&lt;div id='ttls_message'>&lt;/div>"</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 修改觸發頻率</span>
<span class="token keyword">function</span> <span class="token function">ttls_heartbeat_settings</span><span class="token punctuation">(</span> <span class="token variable">$settings</span> <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token variable">$settings</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'interval'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span> <span class="token comment">// Anything between 15-60 seconds</span>
    <span class="token keyword">return</span> <span class="token variable">$settings</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'heartbeat_settings'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ttls_heartbeat_settings'</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// Enqueue heartbeat.js and our JavaScript functions</span>
<span class="token keyword">function</span> <span class="token function">ttls_heartbeat_init</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Only run this on the dashboard page (index.php)</span>
  <span class="token keyword">global</span> <span class="token variable">$pagenow</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span><span class="token punctuation">(</span> <span class="token variable">$pagenow</span> <span class="token operator">!=</span> <span class="token string single-quoted-string">'index.php'</span> <span class="token punctuation">)</span>
  <span class="token keyword">return</span><span class="token punctuation">;</span>

  <span class="token comment">// Enqueue the Heartbeat API</span>
  <span class="token function">wp_enqueue_script</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'heartbeat'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// Load our JavaScript functions in the footer</span>
  <span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"admin_footer"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"ttls_js_wp_footer"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_action</span><span class="token punctuation">(</span><span class="token string double-quoted-string">"admin_init"</span><span class="token punctuation">,</span> <span class="token string double-quoted-string">"ttls_heartbeat_init"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// JavaScript functions ran in the footer</span>
<span class="token keyword">function</span> <span class="token function">ttls_js_wp_footer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token delimiter important">?></span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">></span></span><span class="token script"><span class="token language-javascript">
<span class="token function">jQuery</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>

<span class="token comment">// 送資料給 server</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'heartbeat-send'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
data<span class="token punctuation">[</span><span class="token string">'client'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'check-for-parents'</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 接收從 server 回傳的資料</span>
<span class="token function">jQuery</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'heartbeat-tick'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token keyword">if</span><span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'server'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"ttls_message"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> data<span class="token punctuation">[</span><span class="token string">'server'</span><span class="token punctuation">]</span> 
<span class="token operator">+</span> document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">"ttls_message"</span><span class="token punctuation">)</span><span class="token punctuation">.</span>innerHTML<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">></span></span>
<span class="token php language-php"><span class="token delimiter important">&lt;?php</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 處理從 hearbeat-send 接收到的資料然後傳給 hearbeat-tick</span>
<span class="token keyword">function</span> <span class="token function">ttls_heartbeat_received</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token punctuation">,</span> <span class="token variable">$data</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token comment">// Look for whatever data was passed from JS heartbeat-send function</span>
<span class="token keyword">if</span><span class="token punctuation">(</span><span class="token variable">$data</span><span class="token punctuation">[</span><span class="token string single-quoted-string">'client'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string single-quoted-string">'check-for-parents'</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
  <span class="token comment">// Build whatever response you want</span>
  <span class="token variable">$r</span> <span class="token operator">=</span> <span class="token string single-quoted-string">'&lt;p>'</span><span class="token punctuation">;</span>
  <span class="token variable">$r</span> <span class="token operator">.=</span> <span class="token function">date</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'m/j/y g:i a'</span><span class="token punctuation">,</span> <span class="token function">current_time</span><span class="token punctuation">(</span> <span class="token string single-quoted-string">'timestamp'</span><span class="token punctuation">,</span> <span class="token number">0</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token variable">$r</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">" - Nina Messenlehner's father Brian Messenlehner "</span><span class="token punctuation">;</span>
  <span class="token variable">$r</span> <span class="token operator">.=</span> <span class="token string double-quoted-string">"has arrived in a 2007 White Hummer H2."</span><span class="token punctuation">;</span>
  <span class="token variable">$r</span> <span class="token operator">.=</span> <span class="token string single-quoted-string">'&lt;/p>'</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token variable">$r</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span class="token function">add_filter</span><span class="token punctuation">(</span><span class="token string single-quoted-string">'heartbeat_received'</span><span class="token punctuation">,</span> <span class="token string single-quoted-string">'ttls_heartbeat_received'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
    </div>

    
    
    

      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tw/tags/crontab/" rel="tag"><i class="fa fa-tag"></i> crontab</a>
              <a href="/tw/tags/dashborard/" rel="tag"><i class="fa fa-tag"></i> dashborard</a>
              <a href="/tw/tags/file-header-api/" rel="tag"><i class="fa fa-tag"></i> file header api</a>
              <a href="/tw/tags/heartbeat-api/" rel="tag"><i class="fa fa-tag"></i> heartbeat api</a>
              <a href="/tw/tags/rewrite-rule/" rel="tag"><i class="fa fa-tag"></i> rewrite rule</a>
              <a href="/tw/tags/shortcode/" rel="tag"><i class="fa fa-tag"></i> shortcode</a>
              <a href="/tw/tags/wget/" rel="tag"><i class="fa fa-tag"></i> wget</a>
              <a href="/tw/tags/widget/" rel="tag"><i class="fa fa-tag"></i> widget</a>
              <a href="/tw/tags/wp-mail/" rel="tag"><i class="fa fa-tag"></i> wp_mail</a>
              <a href="/tw/tags/wp-cron/" rel="tag"><i class="fa fa-tag"></i> wp-cron</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/tw/building-web-apps-with-wordpress-plugin/" rel="prev" title="【 書摘 】Building Web Apps with WordPress - 使用 WordPress 外掛">
      <i class="fa fa-chevron-left"></i> 【 書摘 】Building Web Apps with WordPress - 使用 WordPress 外掛
    </a></div>
      <div class="post-nav-item">
    <a href="/tw/woocommerce-order-export/" rel="next" title="【 筆記 】WooCommerce 客製化報表自動匯出&上傳功能開發">
      【 筆記 】WooCommerce 客製化報表自動匯出&上傳功能開發 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Shortcode-API"><span class="nav-number">1.</span> <span class="nav-text">Shortcode API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Shortcode-%E5%B1%AC%E6%80%A7"><span class="nav-number">1.1.</span> <span class="nav-text">Shortcode 屬性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B7%A2%E7%8B%80-Shortocde"><span class="nav-number">1.2.</span> <span class="nav-text">巢狀 Shortocde</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4-Shortcode"><span class="nav-number">1.3.</span> <span class="nav-text">移除 Shortcode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96%E5%AF%A6%E7%94%A8%E7%9A%84-Shortcode-Function"><span class="nav-number">1.4.</span> <span class="nav-text">其他實用的 Shortcode Function</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Widget-API"><span class="nav-number">2.</span> <span class="nav-text">Widget API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E-Widget"><span class="nav-number">2.1.</span> <span class="nav-text">新增 Widget</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9A%E7%BE%A9-Widget-%E5%8D%80%E5%A1%8A"><span class="nav-number">2.2.</span> <span class="nav-text">定義 Widget 區塊</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%9C%A8-Widget-%E5%8D%80%E5%A1%8A%E9%A1%AF%E7%A4%BA-Widget"><span class="nav-number">2.3.</span> <span class="nav-text">不在 Widget 區塊顯示 Widget</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Dashboard-Widget-API"><span class="nav-number">3.</span> <span class="nav-text">Dashboard Widget API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A7%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%B0%8F%E5%B7%A5%E5%85%B7"><span class="nav-number">3.1.</span> <span class="nav-text">移除控制台小工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E%E6%8E%A7%E5%88%B6%E5%8F%B0%E5%B0%8F%E5%B7%A5%E5%85%B7"><span class="nav-number">3.2.</span> <span class="nav-text">新增控制台小工具</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A8%AD%E5%AE%9A%E9%A0%81%E9%9D%A2-API"><span class="nav-number">3.3.</span> <span class="nav-text">設定頁面 API</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E%E5%8E%9F%E7%94%9F%E8%A8%AD%E5%AE%9A%E9%A0%81%E9%9D%A2"><span class="nav-number">3.4.</span> <span class="nav-text">新增原生設定頁面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E%E5%AE%A2%E8%A3%BD%E5%8C%96%E8%A8%AD%E5%AE%9A%E9%A0%81%E9%9D%A2"><span class="nav-number">3.5.</span> <span class="nav-text">新增客製化設定頁面</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Rewrite-API"><span class="nav-number">4.</span> <span class="nav-text">Rewrite API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B0%E5%A2%9E-Rewrite-Rule"><span class="nav-number">4.1.</span> <span class="nav-text">新增 Rewrite Rule</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%B7%E6%96%B0-Rewrite-Rule"><span class="nav-number">4.2.</span> <span class="nav-text">刷新 Rewrite Rule</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B6%E4%BB%96-Rewrite-%E7%9B%B8%E9%97%9C-function"><span class="nav-number">4.3.</span> <span class="nav-text">其他 Rewrite 相關 function</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WP-Cron"><span class="nav-number">5.</span> <span class="nav-text">WP-Cron</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%87%AA%E8%A8%82%E6%8E%92%E7%A8%8B%E9%96%93%E9%9A%94%E6%99%82%E9%96%93"><span class="nav-number">5.1.</span> <span class="nav-text">自訂排程間隔時間</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E4%B8%BB%E6%A9%9F%E6%8E%92%E7%A8%8B%E4%BE%86%E5%9F%B7%E8%A1%8C-wp-cron"><span class="nav-number">5.2.</span> <span class="nav-text">使用主機排程來執行 wp-cron</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E4%BD%BF%E7%94%A8-wp-cron-%E5%8F%AA%E7%94%A8-crontab"><span class="nav-number">5.3.</span> <span class="nav-text">不使用 wp-cron 只用 crontab</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#WP-MAIL-%E7%99%BC%E4%BF%A1"><span class="nav-number">6.</span> <span class="nav-text">WP_MAIL 發信</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%84%AA%E5%8C%96%E9%9B%BB%E5%AD%90%E9%83%B5%E4%BB%B6"><span class="nav-number">6.1.</span> <span class="nav-text">優化電子郵件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%AA%94%E6%A1%88-Header-API"><span class="nav-number">7.</span> <span class="nav-text">檔案 Header API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-get-file-data-%E5%8F%96%E5%BE%97%E6%AA%94%E6%A1%88-Header"><span class="nav-number">7.1.</span> <span class="nav-text">使用 get_file_data() 取得檔案 Header</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B9%AB%E4%BD%88%E6%99%AF%E4%B8%BB%E9%A1%8C%E8%88%87%E5%A4%96%E6%8E%9B%E5%8A%A0%E5%85%A5%E6%96%B0%E7%9A%84%E6%AA%94%E6%A1%88-Header"><span class="nav-number">7.2.</span> <span class="nav-text">幫佈景主題與外掛加入新的檔案 Header</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Heartbeat-API"><span class="nav-number">8.</span> <span class="nav-text">Heartbeat API</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="賴俊吾 / Oberon Lai"
      src="/tw/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">賴俊吾 / Oberon Lai</p>
  <div class="site-description" itemprop="description">現為全職 WordPress 工程師，網站開發經歷 11 年，專攻前端工程與 WordPress 佈景主題、外掛客製化開發</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/tw/archives">
          <span class="site-state-item-count">259</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/tw/categories/">
        <span class="site-state-item-count">38</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tw/tags/">
        <span class="site-state-item-count">80</span>
        <span class="site-state-item-name">標籤</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/oberonlai" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;oberonlai" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:m615926@gmail.com" title="E-Mail → mailto:m615926@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://twitter.com/oberonlai" title="Twitter → https:&#x2F;&#x2F;twitter.com&#x2F;oberonlai" rel="noopener" target="_blank"><i class="fab fa-twitter fa-fw"></i>Twitter</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/m615926" title="FB Page → https:&#x2F;&#x2F;www.facebook.com&#x2F;m615926" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">賴俊吾 / Oberon Lai</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="總字數">601k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="所需總閱讀時間">9:06</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/tw/lib/anime.min.js"></script>
  <script src="/tw/lib/pjax/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/medium-zoom@1/dist/medium-zoom.min.js"></script>

<script src="/tw/js/utils.js"></script>


<script src="/tw/js/schemes/muse.js"></script>


<script src="/tw/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  




  
<script src="/tw/js/local-search.js"></script>













    <div id="pjax">
  

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://oberon-lai.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://oberonlai.blog/tw/building-web-apps-with-wordpress-api-objects-and-helper-functions/";
    this.page.identifier = "building-web-apps-with-wordpress-api-objects-and-helper-functions/";
    this.page.title = "【 書摘 】Building Web Apps with WordPress - 使用 WordPress API、物件、與實用函式";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://oberon-lai.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

    </div>
</body>
</html>
